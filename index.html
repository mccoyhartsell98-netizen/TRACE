<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TRACE — Kiosk</title>

  <style>
    :root{
      --bg:#0b0f16;
      --panel:#101a2a;
      --panel2:#0f1522;
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.7);
      --border:rgba(255,255,255,.12);
      --btn:#0f1b2e;
      --btn2:#122547;
      --accent:#2a7fff;
    }
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Arial;background:radial-gradient(1100px 700px at 25% 10%, rgba(42,127,255,.16), transparent 60%), var(--bg);color:var(--text);}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px;}
    .card{width:min(520px, 95vw);background:linear-gradient(180deg, rgba(16,26,42,.96), rgba(10,14,22,.96));border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden;}
    .top{padding:16px 16px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{font-weight:900;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .body{padding:14px 16px 16px;}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{
      width:100%;background:var(--btn);color:var(--text);
      border:1px solid var(--border);border-radius:14px;
      padding:14px 14px;font-weight:900;letter-spacing:.2px;cursor:pointer;
      transition:.12s transform, .12s background;
    }
    .btn:hover{background:var(--btn2)}
    .btn:active{transform:scale(.985)}
    .btn.secondary{background:transparent}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .pinDots{font-size:22px;letter-spacing:6px;margin:10px 0 6px}
    .msg{font-size:12px;color:var(--muted);min-height:18px}
    input{
      width:100%;background:var(--panel2);color:var(--text);
      border:1px solid var(--border);border-radius:12px;
      padding:12px 12px;font-weight:700;outline:none;
      box-sizing:border-box;
    }
    .section{margin-top:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(15,21,34,.55)}
    .tiny{font-size:12px;color:var(--muted);word-break:break-all;margin-top:8px}
    .hide{display:none!important}

.toast{
      position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
      background:#1a3a1a;border:1px solid #2d7a2d;color:#7fff7f;
      padding:12px 24px;border-radius:999px;font-weight:900;font-size:14px;
      z-index:200;opacity:0;transition:opacity .3s;pointer-events:none;
    }
    .toast.show{opacity:1;}

    /* Modal overlay */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
      display:flex;align-items:center;justify-content:center;z-index:100;padding:18px;
    }
    .modal{
      background:linear-gradient(180deg, rgba(16,26,42,.98), rgba(10,14,22,.98));
      border:1px solid var(--border);border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      width:min(460px,95vw);padding:18px;
    }
    .modal-title{font-weight:900;font-size:15px;margin-bottom:14px}
    .modal-back{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:0;margin-bottom:12px;display:flex;align-items:center;gap:5px}
    .modal-back:hover{color:var(--text)}

    /* Lane/machine grids */
    .lane-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px}
    .machine-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:4px}
    .sel-btn{
      background:var(--btn);color:var(--text);border:1px solid var(--border);
      border-radius:12px;padding:12px 6px;font-weight:700;font-size:13px;
      cursor:pointer;transition:.12s background;text-align:center;
    }
    .sel-btn:hover{background:var(--btn2)}
    .fade-out{animation:fadeOut .2s ease forwards;}
    .fade-in{animation:fadeIn .2s ease forwards;}
    @keyframes fadeOut{from{opacity:1;}to{opacity:0;}}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
  </style>
</head>

<body>
  <div class="wrap">
    <div style="display:flex;flex-direction:column;align-items:center;gap:4px;width:min(520px,95vw)">
      <img src="./trace-logo.png.png" style="height:350px;width:auto;" alt="TRACE" />
      <div class="card" style="width:100%">
        <div class="top">
          <div>
            <div class="sub">Kiosk Access</div>
          </div>
          <div class="pill" id="pillStatus">LOCKED</div>
        </div>
      <div class="body">

        <!-- PIN GATE -->
        <div id="viewPin">
  <div style="font-weight:900;">Select Your Name</div>
  <select id="userSelect" style="width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;font-weight:700;outline:none;margin:10px 0 14px;font-size:15px;">
    <option value="">Loading...</option>
  </select>
  <div style="font-weight:900;">Enter PIN</div>
  <div class="pinDots" id="pinDots">______</div>
          <div class="grid" id="pinPad">
            <button class="btn" data-d="1">1</button>
            <button class="btn" data-d="2">2</button>
            <button class="btn" data-d="3">3</button>
            <button class="btn" data-d="4">4</button>
            <button class="btn" data-d="5">5</button>
            <button class="btn" data-d="6">6</button>
            <button class="btn" data-d="7">7</button>
            <button class="btn" data-d="8">8</button>
            <button class="btn" data-d="9">9</button>
            <button class="btn secondary" id="pinBack">⌫</button>
            <button class="btn" data-d="0">0</button>
            <button class="btn secondary" id="pinClear">C</button>
          </div>

          <div class="grid2">
            <button class="btn" id="pinSubmit">UNLOCK</button>
            <button class="btn secondary" id="pinGoMain">Admin Login</button>
          </div>

          <div class="msg" id="pinMsg"></div>
          <div class="tiny" id="qrPayloadHint"></div>
        </div>

        <!-- HUB -->
        <div id="viewHub" class="hide">
          <div class="row">
            <div style="font-weight:900;" id="hubUser">—</div>
            <button class="btn secondary" style="width:auto;padding:10px 12px" id="hubLogout">Done / Logout</button>
          </div>

          <div class="grid2" style="margin-top:12px">
            <button class="btn" id="hubMove">MOVE</button>
            <button class="btn" id="hubSearch">SEARCH</button>
            <button class="btn" id="hubAdmin">ADMIN</button>
          </div>

          <!-- Scanned Job Card -->
          <div class="section" id="jobCard" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900">Scanned Job</div>
              <div class="pill" id="jobCardStatus">—</div>
            </div>
            <div class="tiny" id="scanLine" style="margin-top:8px">No job loaded</div>
          </div>
        </div>

      </div>
    </div>
  </div>
 </div>

<div class="toast" id="toast"></div>

  <!-- MOVE MODAL — Step 1: Lane or Machine -->
  <div class="modal-overlay hide" id="moveModal">
    <div class="modal">
      <div id="moveStep1">
        <div class="modal-title">Move To — Select Type</div>
        <div class="grid2" style="margin-top:0">
          <button class="btn" id="moveLaneBtn">LANE</button>
          <button class="btn" id="moveMachineBtn">MACHINE</button>
        </div>
        <div style="margin-top:14px">
          <button class="btn secondary" style="width:auto;padding:8px 14px;font-size:13px" id="moveCancel">Cancel</button>
        </div>
      </div>

      <!-- Step 2a: Lane picker -->
      <div id="moveStep2Lane" class="hide">
        <button class="modal-back" id="backFromLane">← Back</button>
        <div class="modal-title">Select Lane</div>
        <div class="lane-grid" id="laneGrid"></div>
      </div>

      <!-- Step 2b: Machine picker -->
      <div id="moveStep2Machine" class="hide">
        <button class="modal-back" id="backFromMachine">← Back</button>
        <div class="modal-title">Select Machine</div>
        <div class="machine-grid" id="machineGrid"></div>
      </div>
    </div>
  </div>

<script>
  const MAIN_TRACE_URL = "./index.html";
  const ADMIN_URL = "./admin.html";
  const API_BASE = "https://trace-api-sak3.onrender.com";

  let pinBuf = "";
  let locations = [];
  let locIdByLane = new Map();
  let locIdByMachine = new Map();
  let inventory = [];

  const qs = new URLSearchParams(location.search);
  const payload = {
    job: qs.get("job") || "",
    mo:  qs.get("mo") || "",
    qty: qs.get("qty") || ""
  };
  
  const scannedJob = (qs.get("job") || "").trim();
  const $ = (id) => document.getElementById(id);
  const show = (a, b) => { $(a).classList.remove("hide"); $(b).classList.add("hide"); };
  const setStatus = (t) => { $("pillStatus").textContent = t; };

  // Build lane buttons 1–12
  const laneGrid = $("laneGrid");
  for (let i = 1; i <= 12; i++) {
    const b = document.createElement("button");
    b.className = "sel-btn";
    b.textContent = `Lane ${i}`;
    b.onclick = () => handleMoveSelection("lane", i);
    laneGrid.appendChild(b);
  }

  // Build machine buttons
  const machines = ["S8","S9","S61","S62","S63","500","Multi Fold","LCI","Six Lane"];
  const machineGrid = $("machineGrid");
  machines.forEach(m => {
    const b = document.createElement("button");
    b.className = "sel-btn";
    b.textContent = m;
    b.onclick = () => handleMoveSelection("machine", m);
    machineGrid.appendChild(b);
  });

function mapLocations(raw){
    const arr = Array.isArray(raw) ? raw : [];
    return arr.map(r => {
      const location_id = Number(r.location_id ?? r.id);
      const laneVal = r.lane ?? r.lane_number ?? r.laneNum;
      const machVal = r.machine ?? r.machine_name ?? r.machineName ?? r.name ?? r.label;
      const laneNum = (laneVal !== undefined && laneVal !== null && String(laneVal).trim() !== "")
        ? Number(String(laneVal).replace(/\D/g,"")) : null;
      const machineName = (machVal !== undefined && machVal !== null && String(machVal).trim() !== "")
        ? String(machVal).trim() : "";
      const type = machineName ? "machine" : (laneNum ? "lane" : "unknown");
      return { location_id, type, laneNum, machineName };
    }).filter(x => Number.isFinite(x.location_id));
  }

  function buildLocationIndexes(){
    locIdByLane = new Map();
    locIdByMachine = new Map();
    locations.forEach(l => {
      if(l.type==="lane"    && l.laneNum)     locIdByLane.set(`Lane ${l.laneNum}`, l.location_id);
      if(l.type==="machine" && l.machineName) locIdByMachine.set(l.machineName, l.location_id);
    });
  }

  async function loadLocations(){
    try{
      const r = await fetch(`${API_BASE}/locations`, { cache:"no-store" });
      const data = await r.json().catch(() => ({}));
      const raw = Array.isArray(data) ? data : (data.locations || data.rows || []);
      locations = mapLocations(raw);
      buildLocationIndexes();
    }catch(e){ console.warn("Locations load failed:", e.message); }
  }

  async function loadInventory(){
    try{
      const r = await fetch(`${API_BASE}/items`, { cache:"no-store" });
      const data = await r.json().catch(() => ({}));
      const raw = Array.isArray(data) ? data : (data.items || data.rows || []);
      inventory = raw.map(it => {
        const id  = it.item_id ?? it.id;
        const job = String(it.job_number ?? it.job ?? "").trim().toUpperCase();
        const mo  = String(it.mo ?? "").trim().toUpperCase();
        const qty = parseInt(it.qty ?? 0, 10);
        const status = String(it.status ?? "").trim();
        const loc_id = Number(it.location_id ?? it.locationId);
        const locObj = locations.find(l => l.location_id === loc_id);
        const lane    = (locObj && locObj.type==="lane")    ? `Lane ${locObj.laneNum}` : "";
        const machine = (locObj && locObj.type==="machine") ? locObj.machineName : "";
        return { id, job, mo, qty, status, lane, machine };
      }).filter(x => x.job.length > 0 && x.status.toLowerCase() !== "deleted");
    }catch(e){ console.warn("Inventory load failed:", e.message); }
  }

  function findItem(query){
    const q = String(query||"").trim().toUpperCase();
    if(!q) return null;
    return inventory.find(x => x.job === q)
        || inventory.find(x => x.mo  === q)
        || inventory.find(x => x.job.includes(q))
        || null;
  }

  function showMoveModal() {
    $("moveModal").classList.remove("hide");
    $("moveStep1").classList.remove("hide");
    $("moveStep2Lane").classList.add("hide");
    $("moveStep2Machine").classList.add("hide");
  }

  function hideMoveModal() {
    $("moveModal").classList.add("hide");
  }

  function handleMoveSelection(type, value) {
    hideMoveModal();
    if (!activeItem) { showToast("No job loaded to move", true); return; }
    const locId = type === "lane" ? locIdByLane.get(`Lane ${value}`) : locIdByMachine.get(value);
    if(!locId){ showToast(`No DB location found for ${type === "lane" ? "Lane "+value : value}`, true); return; }
    const { user } = getAuth();
    const updatedBy = user?.display_name || user?.name || "kiosk";
    const label = type === "lane" ? `Lane ${value}` : value;
    moveItemToLocation(activeItem.id, locId, updatedBy)
      .then(async () => {
        await loadLocations();
        await loadInventory();
        const updated = findItem(activeItem.job);
        if(updated) activeItem = updated;
        const loc = activeItem.machine ? `Machine ${activeItem.machine}` : (activeItem.lane || label);
        $("scanLine").textContent = `Job ${activeItem.job} • MO ${activeItem.mo || "-"} • QTY ${activeItem.qty ?? "-"} • ${loc}`;
        $("jobCardStatus").textContent = activeItem.status || "—";
        showToast(`✓ Moved to ${label}`);
      })
      .catch(e => showToast(e.message || "Move failed", true));
  }

  function showToast(msg, isError = false) {
    const t = $("toast");
    t.textContent = msg;
    t.style.background = isError ? "#3a1a1a" : "#1a3a1a";
    t.style.borderColor = isError ? "#7a2d2d" : "#2d7a2d";
    t.style.color = isError ? "#ff7f7f" : "#7fff7f";
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
  }

  $("moveLaneBtn").onclick = () => {
    $("moveStep1").classList.add("hide");
    $("moveStep2Lane").classList.remove("hide");
  };

  $("moveMachineBtn").onclick = () => {
    $("moveStep1").classList.add("hide");
    $("moveStep2Machine").classList.remove("hide");
  };

  $("backFromLane").onclick = () => {
    $("moveStep2Lane").classList.add("hide");
    $("moveStep1").classList.remove("hide");
  };

  $("backFromMachine").onclick = () => {
    $("moveStep2Machine").classList.add("hide");
    $("moveStep1").classList.remove("hide");
  };

  $("moveCancel").onclick = hideMoveModal;

  // Close modal on overlay click
  $("moveModal").addEventListener("click", (e) => {
    if (e.target === $("moveModal")) hideMoveModal();
  });

  async function checkApi() {
    try {
      const r = await fetch(`${API_BASE}/health`, { cache: "no-store" });
      if (!r.ok) throw new Error("bad status");
      $("pillStatus").textContent = "LOCKED • API OK";
    } catch(e) {
      $("pillStatus").textContent = "LOCKED • API DOWN";
    }
  }

  function renderPinDots() {
    $("pinDots").textContent = (pinBuf + "____").slice(0,4).split("").map(ch => ch === "_" ? "_" : "•").join("");
  }

  function hintPayload() {
    const has = payload.job || payload.mo || payload.qty;
    $("qrPayloadHint").textContent = has
      ? `Loaded from QR → Job: ${payload.job || "-"} • MO: ${payload.mo || "-"} • QTY: ${payload.qty || "-"}`
      : "";
  }

  function saveAuth(token, user) {
    localStorage.setItem("trace_pin_token", token);
    localStorage.setItem("trace_pin_user", JSON.stringify(user));
  }
  function getAuth() {
    return {
      token: localStorage.getItem("trace_pin_token"),
      user: JSON.parse(localStorage.getItem("trace_pin_user") || "null")
    };
  }
  function clearAuth() {
    localStorage.removeItem("trace_pin_token");
    localStorage.removeItem("trace_pin_user");
  }

  async function pinLogin(pin) {
    const r = await fetch(`${API_BASE}/auth/pin-login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin })
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || data.ok === false) throw data;
    return data;
  }

   function showHub() {
    $("viewPin").classList.remove("fade-in");
    $("viewPin").classList.add("fade-out");
    setTimeout(() => {
      $("viewPin").classList.add("hide");
      $("viewPin").classList.remove("fade-out");
      $("viewHub").classList.remove("hide");
      $("viewHub").classList.add("fade-in");
      setTimeout(() => $("viewHub").classList.remove("fade-in"), 200);
    }, 200);
  }

  async function enterHub(user) {
    const name = user.display_name || user.name || (user.role ? user.role.toUpperCase() : "USER");
    const hour = new Date().getHours();
    const greeting = hour < 12 ? "Good Morning" : hour < 17 ? "Good Afternoon" : "Good Evening";
    $("hubUser").textContent = `${greeting}, ${name}!`;
    $("hubAdmin").style.display = (user.role === "admin") ? "block" : "none";
    setStatus("UNLOCKED");
    showHub();
    $("scanLine").textContent = "Loading job...";
    await loadLocations();
    await loadInventory();
    if(scannedJob){
      const item = findItem(scannedJob);
      activeItem = item || null;
      if(item){
        const loc = item.machine ? `Machine ${item.machine}` : (item.lane || "Unknown");
        $("scanLine").textContent = `Job ${item.job} • MO ${item.mo || "-"} • QTY ${item.qty ?? "-"} • ${loc}`;
        $("jobCardStatus").textContent = item.status || "—";
      } else {
        $("scanLine").textContent = `Job #${scannedJob} not found in inventory`;
      }
    } else {
      $("scanLine").textContent = "No job loaded";
      activeItem = null;
    }
  }

    function backToPin(msg = "") {
    pinBuf = "";
    renderPinDots();
    $("pinMsg").textContent = msg;
    setStatus("LOCKED");
    $("viewPin").classList.remove("fade-out", "fade-in");
    $("viewHub").classList.remove("fade-out", "fade-in");
    show("viewPin", "viewHub");
  }

  function goToMain(extra = {}) {
    const url = new URL(MAIN_TRACE_URL, location.href);
    url.searchParams.set("from", "kiosk");
    if (payload.job) url.searchParams.set("job", payload.job);
    if (payload.mo)  url.searchParams.set("mo", payload.mo);
    if (payload.qty) url.searchParams.set("qty", payload.qty);
    for (const [k, v] of Object.entries(extra)) url.searchParams.set(k, v);
    location.href = url.toString();
  }

  // PIN pad
  $("pinPad").addEventListener("click", (e) => {
    const b = e.target.closest("button");
    if (!b) return;
    const d = b.getAttribute("data-d");
    if (d !== null) {
      if (pinBuf.length < 4) pinBuf += d;
      renderPinDots();
    }
  });

  $("pinBack").onclick = () => { pinBuf = pinBuf.slice(0, -1); renderPinDots(); };
  $("pinClear").onclick = () => { pinBuf = ""; renderPinDots(); };

  $("pinSubmit").onclick = async () => {
  if (!/^\d{4}$/.test(pinBuf)) {
    $("pinMsg").textContent = "PIN must be 4 digits";
    return;
  }
  $("pinMsg").textContent = "Checking...";
  try {
    const data = await pinLogin(pinBuf);
    saveAuth(data.token, data.user);
    pinBuf = ""; renderPinDots();
    $("pinMsg").textContent = "";
    enterHub(data.user);
  } catch(err) {
    $("pinMsg").textContent = err?.error || "Invalid PIN";
    pinBuf = ""; renderPinDots();
  }
};

  $("pinGoMain").onclick = () => {
    location.href = new URL(ADMIN_URL, location.href).toString();
  };

  // Hub buttons
  $("hubLogout").onclick = () => { clearAuth(); backToPin("Logged out."); };
  $("hubMove").onclick = showMoveModal;
  $("hubSearch").onclick = () => { goToMain({ intent: "search" }); };
  $("hubAdmin").onclick = () => {
    location.href = new URL(ADMIN_URL, location.href).toString();
  };

  // Scanned job helpers
  let activeItem = null;

  function formatLoc(it) {
    if (!it) return "Unknown";
    if (it.lane) return `Lane ${it.lane}${it.position ? " • " + it.position : ""}`;
    if (it.machine) return `Machine ${it.machine}${it.position ? " • " + it.position : ""}`;
    return "Unassigned";
 
 }
async function fetchJob(job) {
    const r = await fetch(`${API_BASE}/items/lookup?job=${encodeURIComponent(job)}`, { cache: "no-store" });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.ok) throw new Error(data.error || "Lookup failed");
    return data.item;
  }

 async function loadScannedJob() {
    const job = scannedJob;
    if (!job) {
      $("scanLine").textContent = "No job loaded";
      activeItem = null;
      return;
    }
    $("scanLine").textContent = `Loading job ${job}...`;
    try {
      activeItem = await fetchJob(job);
      const loc = formatLoc(activeItem);
      $("scanLine").textContent = `Job ${activeItem.job_number} • MO ${activeItem.mo || "-"} • QTY ${activeItem.qty ?? "-"} • ${loc}`;
    } catch(e) {
      activeItem = null;
      $("scanLine").textContent = `Job ${job} not found in TRACE`;
    }
  }
function renderScannedCard(item) {
    const mo = item.mo || "-";
    const qty = (item.qty ?? "-");
    const lane = item.lane ? `Lane ${item.lane}` : "";
    const machine = item.machine ? `Machine ${item.machine}` : "";
    const where = [lane, machine].filter(Boolean).join(" • ") || "No location";
    document.getElementById("scannedCard").style.display = "block";
    document.getElementById("scannedLine").textContent = `Job ${item.job_number} • MO ${mo} • QTY ${qty}`;
    document.getElementById("scannedLoc").textContent = `Current: ${where}`;
  }

  async function moveItemToLocation(itemId, locationId, updatedBy) {
    const { token } = getAuth();
    const r = await fetch(`${API_BASE}/items/${itemId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ location_id: locationId, updated_by: updatedBy })
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.ok) throw new Error(data.error || "Move failed");
    return data.item;
  }

  function renderScannedError(msg) {
    document.getElementById("scannedCard").style.display = "block";
    document.getElementById("scannedLine").textContent = `Could not load job: ${msg}`;
    document.getElementById("scannedLoc").textContent = "";
  }

async function loadUserDropdown() {
  const select = $("userSelect");
  if (!select) return;
  try {
    const r = await fetch(`${API_BASE}/kiosk-users`);
    const data = await r.json();
    const users = Array.isArray(data) ? data : [];
    select.innerHTML = '<option value="">— Select your name —</option>';
    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = `${u.name} (${u.badge_id})`;
      opt.dataset.role  = u.role;
      opt.dataset.name  = u.name;
      opt.dataset.badge = u.badge_id;
      select.appendChild(opt);
    });
    if (users.length === 0) {
      select.innerHTML = '<option value="">No accounts set up yet</option>';
    }
  } catch(e) {
    console.warn("Could not load kiosk users:", e);
  }
}

  // Boot
  hintPayload();
  renderPinDots();
  checkApi();
  loadUserDropdown();

  (async function boot() {
    await loadLocations();
    await loadInventory();
    loadScannedJob();
    const { token, user } = getAuth();
    if (token && user) {
      enterHub(user);
    } else {
      backToPin("");
    }
  })();
</script>
</body>
</html>
