<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TRACE — Kiosk</title>

  <style>
    :root{
      --bg:#0b0f16;
      --panel:#101a2a;
      --panel2:#0f1522;
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.7);
      --border:rgba(255,255,255,.12);
      --btn:#0f1b2e;
      --btn2:#122547;
      --accent:#2a7fff;
    }
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Arial;background:radial-gradient(1100px 700px at 25% 10%, rgba(42,127,255,.16), transparent 60%), var(--bg);color:var(--text);}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px;}
    .card{width:min(520px, 95vw);background:linear-gradient(180deg, rgba(16,26,42,.96), rgba(10,14,22,.96));border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden;}
    .top{padding:16px 16px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{font-weight:900;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .body{padding:14px 16px 16px;}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{
      width:100%;background:var(--btn);color:var(--text);
      border:1px solid var(--border);border-radius:14px;
      padding:14px 14px;font-weight:900;letter-spacing:.2px;cursor:pointer;
      transition:.12s transform, .12s background;
    }
    .btn:hover{background:var(--btn2)}
    .btn:active{transform:scale(.985)}
    .btn.secondary{background:transparent}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .pinDots{font-size:22px;letter-spacing:6px;margin:10px 0 6px}
    .msg{font-size:12px;color:var(--muted);min-height:18px}
    input{
      width:100%;background:var(--panel2);color:var(--text);
      border:1px solid var(--border);border-radius:12px;
      padding:12px 12px;font-weight:700;outline:none;
      box-sizing:border-box;
    }
    .section{margin-top:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(15,21,34,.55)}
    .tiny{font-size:12px;color:var(--muted);word-break:break-all;margin-top:8px}
    .hide{display:none!important}

    /* Modal overlay */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
      display:flex;align-items:center;justify-content:center;z-index:100;padding:18px;
    }
    .modal{
      background:linear-gradient(180deg, rgba(16,26,42,.98), rgba(10,14,22,.98));
      border:1px solid var(--border);border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      width:min(460px,95vw);padding:18px;
    }
    .modal-title{font-weight:900;font-size:15px;margin-bottom:14px}
    .modal-back{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:0;margin-bottom:12px;display:flex;align-items:center;gap:5px}
    .modal-back:hover{color:var(--text)}

    /* Lane/machine grids */
    .lane-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px}
    .machine-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:4px}
    .sel-btn{
      background:var(--btn);color:var(--text);border:1px solid var(--border);
      border-radius:12px;padding:12px 6px;font-weight:700;font-size:13px;
      cursor:pointer;transition:.12s background;text-align:center;
    }
    .sel-btn:hover{background:var(--btn2)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="brand">TRACE</div>
          <div class="sub">Kiosk Access</div>
        </div>
        <div class="pill" id="pillStatus">LOCKED</div>
      </div>

      <div class="body">

        <!-- PIN GATE -->
        <div id="viewPin">
          <div style="font-weight:900;">Enter PIN</div>
          <div class="pinDots" id="pinDots">______</div>

          <div class="grid" id="pinPad">
            <button class="btn" data-d="1">1</button>
            <button class="btn" data-d="2">2</button>
            <button class="btn" data-d="3">3</button>
            <button class="btn" data-d="4">4</button>
            <button class="btn" data-d="5">5</button>
            <button class="btn" data-d="6">6</button>
            <button class="btn" data-d="7">7</button>
            <button class="btn" data-d="8">8</button>
            <button class="btn" data-d="9">9</button>
            <button class="btn secondary" id="pinBack">⌫</button>
            <button class="btn" data-d="0">0</button>
            <button class="btn secondary" id="pinClear">C</button>
          </div>

          <div class="grid2">
            <button class="btn" id="pinSubmit">UNLOCK</button>
            <button class="btn secondary" id="pinGoMain">Admin Login</button>
          </div>

          <div class="msg" id="pinMsg"></div>
          <div class="tiny" id="qrPayloadHint"></div>
        </div>

        <!-- HUB -->
        <div id="viewHub" class="hide">
          <div class="row">
            <div style="font-weight:900;" id="hubUser">—</div>
            <button class="btn secondary" style="width:auto;padding:10px 12px" id="hubLogout">Done / Logout</button>
          </div>

          <div class="grid2" style="margin-top:12px">
            <button class="btn" id="hubMove">MOVE</button>
            <button class="btn" id="hubSearch">SEARCH</button>
            <button class="btn" id="hubAdmin">ADMIN</button>
          </div>

          <!-- Scanned Job Card -->
          <div class="section" id="jobCard" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900">Scanned Job</div>
              <div class="pill" id="jobCardStatus">—</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MOVE MODAL — Step 1: Lane or Machine -->
  <div class="modal-overlay hide" id="moveModal">
    <div class="modal">
      <div id="moveStep1">
        <div class="modal-title">Move To — Select Type</div>
        <div class="grid2" style="margin-top:0">
          <button class="btn" id="moveLaneBtn">LANE</button>
          <button class="btn" id="moveMachineBtn">MACHINE</button>
        </div>
        <div style="margin-top:14px">
          <button class="btn secondary" style="width:auto;padding:8px 14px;font-size:13px" id="moveCancel">Cancel</button>
        </div>
      </div>

      <!-- Step 2a: Lane picker -->
      <div id="moveStep2Lane" class="hide">
        <button class="modal-back" id="backFromLane">← Back</button>
        <div class="modal-title">Select Lane</div>
        <div class="lane-grid" id="laneGrid"></div>
      </div>

      <!-- Step 2b: Machine picker -->
      <div id="moveStep2Machine" class="hide">
        <button class="modal-back" id="backFromMachine">← Back</button>
        <div class="modal-title">Select Machine</div>
        <div class="machine-grid" id="machineGrid"></div>
      </div>
    </div>
  </div>

<script>
  const MAIN_TRACE_URL = "./index.html";
  const ADMIN_URL = "./admin.html";
  const API_BASE = "https://trace-api-sak3.onrender.com";

  let pinBuf = "";

  const qs = new URLSearchParams(location.search);
  const payload = {
    job: qs.get("job") || "",
    mo:  qs.get("mo") || "",
    qty: qs.get("qty") || ""
  };

  const $ = (id) => document.getElementById(id);
  const show = (a, b) => { $(a).classList.remove("hide"); $(b).classList.add("hide"); };
  const setStatus = (t) => { $("pillStatus").textContent = t; };

  // Build lane buttons 1–12
  const laneGrid = $("laneGrid");
  for (let i = 1; i <= 12; i++) {
    const b = document.createElement("button");
    b.className = "sel-btn";
    b.textContent = `Lane ${i}`;
    b.onclick = () => handleMoveSelection("lane", i);
    laneGrid.appendChild(b);
  }

  // Build machine buttons
  const machines = ["S8","S9","S61","S62","S63","500","Multi Fold","LCI","Six Lane"];
  const machineGrid = $("machineGrid");
  machines.forEach(m => {
    const b = document.createElement("button");
    b.className = "sel-btn";
    b.textContent = m;
    b.onclick = () => handleMoveSelection("machine", m);
    machineGrid.appendChild(b);
  });

  function showMoveModal() {
    $("moveModal").classList.remove("hide");
    $("moveStep1").classList.remove("hide");
    $("moveStep2Lane").classList.add("hide");
    $("moveStep2Machine").classList.add("hide");
  }

  function hideMoveModal() {
    $("moveModal").classList.add("hide");
  }

  function handleMoveSelection(type, value) {
    hideMoveModal();
    goToMain({ intent: "move", moveType: type, moveTo: value });
  }

  $("moveLaneBtn").onclick = () => {
    $("moveStep1").classList.add("hide");
    $("moveStep2Lane").classList.remove("hide");
  };

  $("moveMachineBtn").onclick = () => {
    $("moveStep1").classList.add("hide");
    $("moveStep2Machine").classList.remove("hide");
  };

  $("backFromLane").onclick = () => {
    $("moveStep2Lane").classList.add("hide");
    $("moveStep1").classList.remove("hide");
  };

  $("backFromMachine").onclick = () => {
    $("moveStep2Machine").classList.add("hide");
    $("moveStep1").classList.remove("hide");
  };

  $("moveCancel").onclick = hideMoveModal;

  // Close modal on overlay click
  $("moveModal").addEventListener("click", (e) => {
    if (e.target === $("moveModal")) hideMoveModal();
  });

  async function checkApi() {
    try {
      const r = await fetch(`${API_BASE}/health`, { cache: "no-store" });
      if (!r.ok) throw new Error("bad status");
      $("pillStatus").textContent = "LOCKED • API OK";
    } catch(e) {
      $("pillStatus").textContent = "LOCKED • API DOWN";
    }
  }

  function renderPinDots() {
    $("pinDots").textContent = (pinBuf + "____").slice(0,4).split("").map(ch => ch === "_" ? "_" : "•").join("");
  }

  function hintPayload() {
    const has = payload.job || payload.mo || payload.qty;
    $("qrPayloadHint").textContent = has
      ? `Loaded from QR → Job: ${payload.job || "-"} • MO: ${payload.mo || "-"} • QTY: ${payload.qty || "-"}`
      : "";
  }

  function saveAuth(token, user) {
    localStorage.setItem("trace_pin_token", token);
    localStorage.setItem("trace_pin_user", JSON.stringify(user));
  }
  function getAuth() {
    return {
      token: localStorage.getItem("trace_pin_token"),
      user: JSON.parse(localStorage.getItem("trace_pin_user") || "null")
    };
  }
  function clearAuth() {
    localStorage.removeItem("trace_pin_token");
    localStorage.removeItem("trace_pin_user");
  }

  async function pinLogin(pin) {
    const r = await fetch(`${API_BASE}/auth/pin-login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin })
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || data.ok === false) throw data;
    return data;
  }

  function enterHub(user){
  const name = (user.display_name || "Worker").trim();
  const role = String(user.role || "worker").toUpperCase();

  $("hubUser").textContent = `Hello, ${name}`;
  // optional small text somewhere:
  // $("hubRole").textContent = role;

  $("hubAdmin").style.display = (user.role === "admin") ? "block" : "none";
  setStatus("UNLOCKED");
  show("viewHub","viewPin");
}

  function backToPin(msg = "") {
    pinBuf = "";
    renderPinDots();
    $("pinMsg").textContent = msg;
    setStatus("LOCKED");
    show("viewPin", "viewHub");
  }

  function goToMain(extra = {}) {
    const url = new URL(MAIN_TRACE_URL, location.href);
    url.searchParams.set("from", "kiosk");
    if (payload.job) url.searchParams.set("job", payload.job);
    if (payload.mo)  url.searchParams.set("mo", payload.mo);
    if (payload.qty) url.searchParams.set("qty", payload.qty);
    for (const [k, v] of Object.entries(extra)) url.searchParams.set(k, v);
    location.href = url.toString();
  }

  // PIN pad
  $("pinPad").addEventListener("click", (e) => {
    const b = e.target.closest("button");
    if (!b) return;
    const d = b.getAttribute("data-d");
    if (d !== null) {
      if (pinBuf.length < 4) pinBuf += d;
      renderPinDots();
    }
  });

  $("pinBack").onclick = () => { pinBuf = pinBuf.slice(0, -1); renderPinDots(); };
  $("pinClear").onclick = () => { pinBuf = ""; renderPinDots(); };

  $("pinSubmit").onclick = async () => {
    $("pinMsg").textContent = "Checking...";
    try {
      if (!/^\d{4}$/.test(pinBuf)) { $("pinMsg").textContent = "PIN must be 4 digits"; return; }
      const data = await pinLogin(pinBuf);
      saveAuth(data.token, data.user);
      pinBuf = ""; renderPinDots();
      $("pinMsg").textContent = "";
      enterHub(data.user);
    } catch(err) {
      $("pinMsg").textContent = err?.error || "Invalid PIN";
    }
  };

  $("pinGoMain").onclick = () => {
    location.href = new URL(ADMIN_URL, location.href).toString();
  };

  // Hub buttons
  $("hubLogout").onclick = () => { clearAuth(); backToPin("Logged out."); };
  $("hubMove").onclick = showMoveModal;
  $("hubSearch").onclick = () => { goToMain({ intent: "search" }); };
  $("hubAdmin").onclick = () => {
    location.href = new URL(ADMIN_URL, location.href).toString();
  };

  // Boot
  hintPayload();
  renderPinDots();
  checkApi();

  (function autoUnlock() {
    const { token, user } = getAuth();
    if (token && user) {
      enterHub(user);
    } else {
      backToPin("");
    }
  })();
</script>
</body>
</html>
