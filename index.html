<script>
/* =========================
   TRACE — STABLE BUILD (DB location_id ↔ UI lane/machine)
   Fixes:
   - Maps items using location_id + /locations
   - Uses lastSelectedType so lane click actually counts
   - Handles different API field names safely
   ========================= */

/* API */
const API_BASE = "https://trace-api-sak3.onrender.com";

async function apiGet(path){
  const r = await fetch(`${API_BASE}${path}`);
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}
async function apiPost(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}
async function apiPut(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}

/* local deleted history */
const DELETED_KEY = "trace_simple_deleted_v1";

/* MACHINES */
const MACHINES = ["S8","S9","S61","S62","S63","500","Multi Fold","LCI","Six Lane"];

/* CHANGE THIS PIN ANYTIME */
const ADMIN_PIN = "4793";

/* DOM */
const els = {
  itemsPill: document.getElementById("itemsPill"),
  rolePill: document.getElementById("rolePill"),

  roleSelect: document.getElementById("roleSelect"),
  adminUnlockBtn: document.getElementById("adminUnlockBtn"),
  adminLockBtn: document.getElementById("adminLockBtn"),

  globalSearch: document.getElementById("globalSearch"),
  globalResults: document.getElementById("globalResults"),

  laneGrid: document.getElementById("laneGrid"),
  laneTitle: document.getElementById("laneTitle"),
  laneCount: document.getElementById("laneCount"),
  laneSearch: document.getElementById("laneSearch"),
  laneResults: document.getElementById("laneResults"),

  machineGrid: document.getElementById("machineGrid"),
  machineTitle: document.getElementById("machineTitle"),
  machineCount: document.getElementById("machineCount"),
  machineSearch: document.getElementById("machineSearch"),
  machineResults: document.getElementById("machineResults"),

  moveOverlay: document.getElementById("moveOverlay"),
  moveTitle: document.getElementById("moveTitle"),
  moveCloseBtn: document.getElementById("moveCloseBtn"),
  moveLaneGrid: document.getElementById("moveLaneGrid"),
  moveMachineGrid: document.getElementById("moveMachineGrid"),

  job: document.getElementById("job"),
  qty: document.getElementById("qty"),
  status: document.getElementById("status"),
  notes: document.getElementById("notes"),
  updatedBy: document.getElementById("updatedBy"),
  saveBtn: document.getElementById("saveBtn"),
  newBtn: document.getElementById("newBtn"),
  deleteBtn: document.getElementById("deleteBtn"),

  historyBtn: document.getElementById("historyBtn"),
  historyPanel: document.getElementById("historyPanel"),
  historySearch: document.getElementById("historySearch"),
  historyResults: document.getElementById("historyResults"),

  exportBtn: document.getElementById("exportBtn"),
  importBtn: document.getElementById("importBtn"),
  seedBtn: document.getElementById("seedBtn"),
  fileInput: document.getElementById("fileInput"),
};

function assertEls(){
  const missing = Object.entries(els).filter(([k,v]) => !v).map(([k]) => k);
  if(missing.length) throw new Error("Missing DOM elements: " + missing.join(", "));
}
assertEls();

/* STATE */
let inventory = [];
let locationsRaw = [];
let locations = []; // normalized locations
let deletedItems = loadDeleted();

let selectedLane = "Lane 1";
let selectedMachine = MACHINES[0];
let selectedId = null;

// IMPORTANT: track what the user LAST clicked
let lastSelectedType = "lane"; // "lane" | "machine"

let role = "forklift";
let adminUnlocked = false;

let moveTargetId = null;

/* helpers */
function normalize(s){ return (s ?? "").toString().trim().toLowerCase(); }
function onlyDigits(s){ return String(s ?? "").replace(/\D+/g, ""); }

function nowStamp(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const yy = String(d.getFullYear()).slice(-2);
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${mm}/${dd}/${yy} ${hh}:${mi}`;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* deleted history local */
function saveDeleted(){ localStorage.setItem(DELETED_KEY, JSON.stringify(deletedItems)); }
function loadDeleted(){
  try{
    const raw = localStorage.getItem(DELETED_KEY);
    if(!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  }catch{return [];}
}

/* =========================
   NORMALIZE LOCATION + ITEM SHAPES
   ========================= */

function normalizeLocations(rows){
  // Accepts lots of possible field names safely
  // Expected minimum: location_id AND (lane OR machine)
  return (Array.isArray(rows) ? rows : []).map(r => {
    const location_id = r.location_id ?? r.id ?? r.locationId ?? r.locationID;

    // lane could be: 1..12 OR "Lane 1" OR lane_name/label
    const laneVal =
      r.lane ?? r.lane_num ?? r.lane_number ?? r.laneNumber ??
      r.lane_name ?? r.laneName ?? r.label ?? r.name;

    // machine could be: "S8" etc
    const machineVal =
      r.machine ?? r.machine_name ?? r.machineName ?? r.machine_label ?? r.machineLabel;

    let laneNum = null;
    let laneLabel = "";
    if(laneVal !== undefined && laneVal !== null && String(laneVal).trim() !== ""){
      const raw = String(laneVal).trim();
      const n = parseInt(raw.replace(/\D/g,""), 10);
      if(Number.isFinite(n) && n > 0) laneNum = n;
      laneLabel = raw.toLowerCase().startsWith("lane") ? `Lane ${n}` : (laneNum ? `Lane ${laneNum}` : raw);
    }

    let machineLabel = "";
    if(machineVal !== undefined && machineVal !== null && String(machineVal).trim() !== ""){
      machineLabel = String(machineVal).trim();
    }

    return { location_id, laneNum, laneLabel, machineLabel };
  }).filter(x => x.location_id != null);
}

function mapItemsFromApi(itemsRows){
  const rows = Array.isArray(itemsRows) ? itemsRows : [];

  return rows.map(r => {
    const id = r.item_id ?? r.id ?? r.itemId;
    const job = onlyDigits(r.job_number ?? r.job ?? r.jobNumber ?? "");
    const qty = Number.isFinite(r.qty) ? r.qty : (parseInt(r.qty ?? "0",10) || 0);
    const status = (r.status ?? "").toString();
    const notes  = (r.notes ?? "").toString();
    const updatedBy = (r.updated_by ?? r.updatedBy ?? "").toString();
    const createdAt = (r.created_at ?? r.createdAt ?? "").toString();
    const updatedAt = (r.updated_at ?? r.updatedAt ?? "").toString();
    const location_id = r.location_id ?? r.locationId ?? null;

    // If API already provides lane/machine, keep them; otherwise derive from locations
    let lane = (r.lane ?? "").toString();
    let machine = (r.machine ?? "").toString();

    if((!lane && !machine) && location_id != null){
      const loc = locations.find(l => String(l.location_id) === String(location_id));
      if(loc){
        lane = loc.laneLabel || "";
        machine = loc.machineLabel || "";
      }
    }

    return {
      id,
      job,
      qty,
      status,
      notes,
      updatedBy,
      createdAt,
      updatedAt,
      location_id,
      lane,
      machine
    };
  }).filter(x => String(x.job).length > 0);
}

/* data load */
async function loadLocations(){
  const data = await apiGet("/locations");
  locationsRaw = data;
  locations = normalizeLocations(data);
}

async function loadInventory(){
  const data = await apiGet("/items");
  return mapItemsFromApi(data);
}

/* =========================
   ROLE
   ========================= */

function setRole(nextRole){
  role = nextRole;

  if(role !== "admin"){
    adminUnlocked = false;
    els.adminLockBtn.style.display = "none";
    els.adminUnlockBtn.style.display = "inline-block";
  }

  updateRoleUI();
  renderLaneList();
  renderMachineList();
  renderGlobalSearch();
}

function updateRoleUI(){
  const effectiveRole = (role === "admin" && adminUnlocked) ? "ADMIN" : role.toUpperCase();
  els.rolePill.textContent = `ROLE: ${effectiveRole}`;

  const canDelete = (role === "admin" && adminUnlocked);
  els.deleteBtn.disabled = !canDelete || !selectedId;

  const forklift = role === "forklift";
  const admin = (role === "admin" && adminUnlocked);

  const canCreate = admin;
  const hasSelection = !!selectedId;

  els.job.disabled = hasSelection || !canCreate;

  els.qty.disabled = forklift;
  els.status.disabled = forklift;
  els.notes.disabled = forklift;
  els.updatedBy.disabled = forklift;

  els.saveBtn.disabled = forklift;
  els.newBtn.disabled = forklift;
}

/* =========================
   BUTTONS
   ========================= */

function buildLaneButtons(){
  els.laneGrid.innerHTML = "";
  for(let i=1;i<=12;i++){
    const lane = `Lane ${i}`;
    const btn = document.createElement("div");
    btn.className = "laneBtn" + (lane===selectedLane ? " active" : "");
    btn.textContent = lane;
    btn.addEventListener("click", () => selectLane(lane));
    els.laneGrid.appendChild(btn);
  }
}

function selectLane(lane){
  lastSelectedType = "lane";
  selectedLane = lane;
  selectedId = null;

  buildLaneButtons();
  els.laneTitle.textContent = lane;
  els.laneSearch.value = "";

  clearForm();
  renderLaneList();
  renderGlobalSearch();
}

function buildMachineButtons(){
  els.machineGrid.innerHTML = "";
  MACHINES.forEach(m => {
    const btn = document.createElement("div");
    btn.className = "laneBtn" + (m===selectedMachine ? " active" : "");
    btn.textContent = m;
    btn.addEventListener("click", () => selectMachine(m));
    els.machineGrid.appendChild(btn);
  });
}

function selectMachine(m){
  lastSelectedType = "machine";
  selectedMachine = m;
  selectedId = null;

  buildMachineButtons();
  els.machineTitle.textContent = `Machine: ${m}`;
  els.machineSearch.value = "";

  clearForm();
  renderMachineList();
  renderGlobalSearch();
}

/* =========================
   RENDER LISTS
   ========================= */

function renderLaneList(){
  const q = normalize(els.laneSearch.value);

  const laneItemsAll = inventory.filter(x => String(x.lane ?? "") === selectedLane);

  let laneItems = laneItemsAll;
  if(q){
    laneItems = laneItemsAll.filter(x =>
      normalize(x.job).includes(q) ||
      normalize(x.status).includes(q)
    );
  }

  els.laneCount.textContent = `${laneItemsAll.length} items`;
  els.laneResults.innerHTML = "";

  if(laneItemsAll.length === 0){
    els.laneResults.innerHTML = `<div style="color:var(--muted)">Empty lane.</div>`;
    return;
  }
  if(laneItems.length === 0){
    els.laneResults.innerHTML = `<div style="color:var(--muted)">No match in this lane.</div>`;
    return;
  }

  laneItems.sort((a,b) => (parseInt(a.job,10)||0) - (parseInt(b.job,10)||0));

  laneItems.forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem" + (item.id===selectedId ? " active" : "");

    const by = item.updatedBy ? ` • ${escapeHtml(item.updatedBy)}` : "";
    const at = item.updatedAt ? ` • ${escapeHtml(item.updatedAt)}` : "";
    const status = item.status ? escapeHtml(item.status) : "—";
    const notes = item.notes ? escapeHtml(item.notes) : "—";

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="qty">Qty: ${Number.isFinite(item.qty) ? item.qty : 0} • Status: ${status}</div>
      <div class="meta">${escapeHtml(item.lane)} • Notes: ${notes}${by}${at}</div>
    `;
    div.addEventListener("click", ()=> loadToForm(item.id));
    els.laneResults.appendChild(div);
  });
}

function renderMachineList(){
  const q = normalize(els.machineSearch.value);

  const machineItemsAll = inventory.filter(x => String(x.machine ?? "") === selectedMachine);

  let machineItems = machineItemsAll;
  if(q){
    machineItems = machineItemsAll.filter(x =>
      normalize(x.job).includes(q) ||
      normalize(x.status).includes(q)
    );
  }

  els.machineCount.textContent = `${machineItemsAll.length} jobs`;
  els.machineResults.innerHTML = "";

  if(machineItemsAll.length === 0){
    els.machineResults.innerHTML = `<div style="color:var(--muted)">Empty machine.</div>`;
    return;
  }
  if(machineItems.length === 0){
    els.machineResults.innerHTML = `<div style="color:var(--muted)">No match on this machine.</div>`;
    return;
  }

  machineItems.sort((a,b) => (parseInt(a.job,10)||0) - (parseInt(b.job,10)||0));

  machineItems.forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem" + (item.id===selectedId ? " active" : "");

    const by = item.updatedBy ? ` • ${escapeHtml(item.updatedBy)}` : "";
    const at = item.updatedAt ? ` • ${escapeHtml(item.updatedAt)}` : "";
    const status = item.status ? escapeHtml(item.status) : "—";
    const notes = item.notes ? escapeHtml(item.notes) : "—";

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="qty">Qty: ${Number.isFinite(item.qty) ? item.qty : 0} • Status: ${status}</div>
      <div class="meta">Machine: ${escapeHtml(item.machine)} • Notes: ${notes}${by}${at}</div>
    `;
    div.addEventListener("click", ()=> loadToForm(item.id));
    els.machineResults.appendChild(div);
  });
}

function renderGlobalSearch(){
  const q = normalize(els.globalSearch.value);
  els.globalResults.innerHTML = "";

  if(!q){
    els.globalResults.innerHTML = `<div style="color:var(--muted)">Type a Job # to search all lanes/machines.</div>`;
    return;
  }

  const matches = inventory
    .filter(x => normalize(x.job).includes(q))
    .slice(0, 15);

  if(matches.length === 0){
    els.globalResults.innerHTML = `<div style="color:var(--muted)">No match found.</div>`;
    return;
  }

  matches.forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem";

    const created = item.createdAt ? escapeHtml(item.createdAt) : "—";
    const updated = item.updatedAt ? escapeHtml(item.updatedAt) : "—";
    const status = item.status ? escapeHtml(item.status) : "—";
    const notes = item.notes ? escapeHtml(item.notes) : "—";

    const canMove = (role === "forklift") || (role === "admin" && adminUnlocked);

    const location = item.machine
      ? `Machine: ${escapeHtml(item.machine)}`
      : (item.lane ? escapeHtml(item.lane) : "—");

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="qty">Qty: ${Number.isFinite(item.qty) ? item.qty : 0} • Status: ${status}</div>
      <div class="meta">
        ${location}
        • Added: ${created}
        • Updated: ${updated}
        • Notes: ${notes}
      </div>
      ${canMove ? `
        <div class="btnRow" style="margin-top:10px;">
          <button class="primary" data-move="1">Move</button>
        </div>
      ` : ``}
    `;

    const moveBtn = div.querySelector('[data-move]');
    if(moveBtn){
      moveBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openMoveOverlay(item.id);
      });
    }

    div.addEventListener("click", () => {
      if(item.machine){
        selectMachine(item.machine);
      }else if(item.lane){
        selectLane(item.lane);
      }
      loadToForm(item.id);
    });

    els.globalResults.appendChild(div);
  });
}

/* =========================
   FORM
   ========================= */

function clearForm(){
  selectedId = null;
  els.job.value = "";
  els.qty.value = "";
  els.status.value = "";
  els.notes.value = "";
  els.updatedBy.value = "";
  updateRoleUI();
}

function loadToForm(id){
  const item = inventory.find(x => String(x.id) === String(id));
  if(!item) return;

  selectedId = item.id;

  els.job.value = item.job ?? "";
  els.qty.value = String(item.qty ?? 0);
  els.status.value = item.status ?? "";
  els.notes.value = item.notes ?? "";
  els.updatedBy.value = item.updatedBy ?? "";

  updateRoleUI();
  renderLaneList();
  renderMachineList();
}

/* =========================
   LOCATION LOOKUP (THE BIG FIX)
   ========================= */

function getSelectedLocationId(){
  // Use what user LAST clicked, not whichever variable happens to be non-empty
  if(lastSelectedType === "machine"){
    const row = locations.find(l => normalize(l.machineLabel) === normalize(selectedMachine));
    return row ? row.location_id : null;
  }

  // lane
  const laneNum = parseInt(String(selectedLane).replace(/\D/g, ""), 10);
  const row = locations.find(l => Number(l.laneNum) === laneNum || normalize(l.laneLabel) === normalize(selectedLane));
  return row ? row.location_id : null;
}

/* =========================
   SAVE/UPDATE (API)
   ========================= */

async function upsertItem(){
  const machineRole = role === "machine";
  const admin = (role === "admin" && adminUnlocked);

  if(!(machineRole || admin)){
    alert("Forklift role cannot edit job details.");
    return;
  }

  if(machineRole && !selectedId){
    alert("Machine role cannot create new jobs. Ask Admin.");
    return;
  }

  const jobRaw = onlyDigits(els.job.value).trim();
  if(!jobRaw){
    alert("Job # is required (numbers only).");
    els.job.focus();
    return;
  }

  const qty = Math.max(0, parseInt(els.qty.value || "0", 10));
  const status = (els.status.value || "").trim().slice(0, 40);
  const notes  = (els.notes.value  || "").trim().slice(0, 120);
  const updatedBy = (els.updatedBy.value || "").trim().slice(0, 10);

  const location_id = getSelectedLocationId();
  if(!location_id){
    alert(`No DB mapping for ${lastSelectedType === "lane" ? `"${selectedLane}"` : `"${selectedMachine}"`}.
Fix /locations seeding OR field names.`);
    return;
  }

  const payload = {
    job_number: jobRaw,
    description: "",           // safe default if backend expects it
    qty,
    status,
    notes,
    updated_by: updatedBy,
    location_id
  };

  // only block duplicates when creating
  if(!selectedId){
    const exists = inventory.some(x => normalize(x.job) === normalize(jobRaw));
    if(exists){
      alert("That Job # already exists. Search it and update it instead.");
      return;
    }
  }

  try{
    if(selectedId){
      await apiPut(`/items/${selectedId}`, payload);
    }else{
      await apiPost(`/items`, payload);
    }

    // reload
    inventory = await loadInventory();
    els.itemsPill.textContent = `ITEMS: ${inventory.length}`;

    renderLaneList();
    renderMachineList();
    renderGlobalSearch();
    if(els.historyPanel && els.historyPanel.style.display !== "none") renderHistory();

    clearForm();
  }catch(err){
    console.error("SAVE FAILED", err);
    alert("Save failed. Open DevTools → Network and check the /items request.");
  }
}

/* DELETE (LOCAL ONLY FOR NOW) */
function deleteSelected(){
  const admin = (role === "admin" && adminUnlocked);
  if(!admin){
    alert("Only Admin can delete.");
    return;
  }
  if(!selectedId) return;

  const item = inventory.find(x => String(x.id) === String(selectedId));
  const ok = confirm(`Delete Job #${item?.job ?? ""}? (It will go to History)`);
  if(!ok) return;

  const toDelete = inventory.find(x => String(x.id) === String(selectedId));
  if(toDelete){
    deletedItems.unshift({ ...toDelete, deletedAt: nowStamp() });
    saveDeleted();
  }

  inventory = inventory.filter(x => String(x.id) !== String(selectedId));
  els.itemsPill.textContent = `ITEMS: ${inventory.length}`;

  clearForm();
  renderLaneList();
  renderMachineList();
  renderGlobalSearch();
  if(els.historyPanel.style.display !== "none") renderHistory();
}

/* move overlay (LOCAL ONLY FOR NOW) */
function openMoveOverlay(id){
  const item = inventory.find(x => String(x.id) === String(id));
  if(!item) return;

  const allowed = (role === "forklift") || (role === "admin" && adminUnlocked);
  if(!allowed){
    alert("Only Forklift (or Admin) can move jobs.");
    return;
  }

  moveTargetId = item.id;
  els.moveTitle.textContent = `Move Job #${item.job}`;

  els.moveLaneGrid.innerHTML = "";
  for(let i=1;i<=12;i++){
    const lane = `Lane ${i}`;
    const btn = document.createElement("div");
    btn.className = "laneBtn";
    btn.textContent = lane;
    btn.addEventListener("click", () => {
      // LOCAL move only (UI). Real move should update location_id on backend later.
      item.lane = lane;
      item.machine = "";
      item.updatedAt = nowStamp();
      lastSelectedType = "lane";
      selectLane(lane);
      renderMachineList();
      renderGlobalSearch();
      loadToForm(item.id);
      closeMoveOverlay();
    });
    els.moveLaneGrid.appendChild(btn);
  }

  els.moveMachineGrid.innerHTML = "";
  MACHINES.forEach(m => {
    const btn = document.createElement("div");
    btn.className = "laneBtn";
    btn.textContent = m;
    btn.addEventListener("click", () => {
      item.machine = m;
      item.lane = "";
      item.updatedAt = nowStamp();
      lastSelectedType = "machine";
      selectMachine(m);
      renderLaneList();
      renderGlobalSearch();
      loadToForm(item.id);
      closeMoveOverlay();
    });
    els.moveMachineGrid.appendChild(btn);
  });

  els.moveOverlay.classList.add("show");
}

function closeMoveOverlay(){
  els.moveOverlay.classList.remove("show");
  moveTargetId = null;
}

/* history */
function toggleHistory(){
  const open = els.historyPanel.style.display !== "none";
  els.historyPanel.style.display = open ? "none" : "block";
  if(!open){
    els.historySearch.value = "";
    renderHistory();
  }
}

function renderHistory(){
  const q = normalize(els.historySearch.value);
  els.historyResults.innerHTML = "";

  let list = deletedItems;
  if(q){
    list = deletedItems.filter(x =>
      normalize(x.job).includes(q) ||
      normalize(x.lane).includes(q) ||
      normalize(x.machine).includes(q)
    );
  }

  if(list.length === 0){
    els.historyResults.innerHTML = `<div style="color:var(--muted)">No deleted jobs.</div>`;
    return;
  }

  list.slice(0, 60).forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem";

    const when = item.deletedAt ? escapeHtml(item.deletedAt) : "—";
    const status = item.status ? escapeHtml(item.status) : "—";
    const notes = item.notes ? escapeHtml(item.notes) : "—";

    const wasWhere = item.machine
      ? `Machine: ${escapeHtml(item.machine)}`
      : `Was: ${escapeHtml(item.lane || "—")}`;

    const canRestore = (role === "admin" && adminUnlocked);

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="qty">Qty: ${Number.isFinite(item.qty) ? item.qty : 0} • Status: ${status}</div>
      <div class="meta">${wasWhere} • Deleted: ${when} • Notes: ${notes}</div>
      ${canRestore ? `
        <div class="btnRow" style="margin-top:10px;">
          <button class="primary" data-restore="1">Restore</button>
        </div>
      ` : `<div class="tiny">Admin required to restore.</div>`}
    `;

    const restoreBtn = div.querySelector('[data-restore]');
    if(restoreBtn){
      restoreBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        restoreDeleted(item.id);
      });
    }

    els.historyResults.appendChild(div);
  });
}

function restoreDeleted(id){
  const admin = (role === "admin" && adminUnlocked);
  if(!admin){
    alert("Only Admin can restore.");
    return;
  }

  const idx = deletedItems.findIndex(x => String(x.id) === String(id));
  if(idx < 0) return;

  const item = deletedItems[idx];
  deletedItems.splice(idx, 1);
  saveDeleted();

  inventory.unshift({ ...item, deletedAt: undefined });

  els.itemsPill.textContent = `ITEMS: ${inventory.length}`;
  renderLaneList();
  renderMachineList();
  renderGlobalSearch();
  renderHistory();
}

/* backup */
function exportJson(){
  const blob = new Blob([JSON.stringify(inventory, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `trace_backup_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

function importJsonFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(!Array.isArray(data)) throw new Error("Invalid file format.");

      inventory = data.map(x => ({
        id: x.id,
        job: onlyDigits(x.job ?? x.job_number ?? ""),
        lane: String(x.lane || ""),
        machine: String(x.machine || ""),
        qty: Number.isFinite(x.qty) ? x.qty : parseInt(x.qty || "0",10) || 0,
        status: String(x.status || ""),
        notes: String(x.notes || ""),
        updatedBy: String(x.updatedBy || "").slice(0,10),
        createdAt: String(x.createdAt || ""),
        updatedAt: String(x.updatedAt || "")
      })).filter(x => String(x.job).length > 0);

      els.itemsPill.textContent = `ITEMS: ${inventory.length}`;
      clearForm();
      renderLaneList();
      renderMachineList();
      renderGlobalSearch();
      alert("Import complete.");
    }catch(e){
      alert("Import failed: " + e.message);
    }
  };
  reader.readAsText(file);
}

function seedDemo(){
  const stamp = nowStamp();
  inventory = [
    { id:"demo1", job:"400848", lane:"Lane 7", machine:"", qty:12, status:"WAITING", notes:"", updatedBy:"TR", createdAt:stamp, updatedAt:stamp },
    { id:"demo2", job:"70800",  lane:"", machine:"S8", qty:30, status:"RUNNING", notes:"", updatedBy:"TR", createdAt:stamp, updatedAt:stamp },
    { id:"demo3", job:"123456", lane:"Lane 1", machine:"", qty:50, status:"READY",   notes:"", updatedBy:"TR", createdAt:stamp, updatedAt:stamp },
    ...inventory
  ];

  const seen = new Set();
  inventory = inventory.filter(x => {
    const key = normalize(x.job);
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  els.itemsPill.textContent = `ITEMS: ${inventory.length}`;
  renderLaneList();
  renderMachineList();
  renderGlobalSearch();
}

/* fullscreen */
function toggleFullscreen(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  }else{
    document.exitFullscreen().catch(()=>{});
  }
}

/* events */
els.globalSearch.addEventListener("input", renderGlobalSearch);
els.laneSearch.addEventListener("input", renderLaneList);
els.machineSearch.addEventListener("input", renderMachineList);

els.saveBtn.addEventListener("click", upsertItem);
els.newBtn.addEventListener("click", clearForm);
els.deleteBtn.addEventListener("click", deleteSelected);

els.exportBtn.addEventListener("click", exportJson);
els.importBtn.addEventListener("click", () => els.fileInput.click());
els.fileInput.addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  if(file) importJsonFile(file);
  els.fileInput.value = "";
});
els.seedBtn.addEventListener("click", seedDemo);

els.historyBtn.addEventListener("click", toggleHistory);
els.historySearch.addEventListener("input", renderHistory);

els.moveCloseBtn.addEventListener("click", closeMoveOverlay);
els.moveOverlay.addEventListener("click", (e) => {
  if(e.target === els.moveOverlay) closeMoveOverlay();
});

/* Role events */
els.roleSelect.addEventListener("change", (e) => {
  const v = e.target.value;
  if(v === "admin"){
    setRole("admin");
  }else{
    setRole(v);
  }
});

els.adminUnlockBtn.addEventListener("click", () => {
  const pin = prompt("Enter Admin PIN:");
  if(pin === null) return;
  if(String(pin).trim() !== ADMIN_PIN){
    alert("Wrong PIN.");
    els.roleSelect.value = "forklift";
    setRole("forklift");
    return;
  }
  role = "admin";
  adminUnlocked = true;
  els.adminUnlockBtn.style.display = "none";
  els.adminLockBtn.style.display = "inline-block";
  els.roleSelect.value = "admin";
  updateRoleUI();
  renderGlobalSearch();
});

els.adminLockBtn.addEventListener("click", () => {
  adminUnlocked = false;
  els.adminLockBtn.style.display = "none";
  els.adminUnlockBtn.style.display = "inline-block";
  els.roleSelect.value = "forklift";
  setRole("forklift");
});

els.job.addEventListener("input", () => {
  els.job.value = onlyDigits(els.job.value);
});

document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "f") toggleFullscreen();
  if(e.key === "Escape") closeMoveOverlay();

  const tag = document.activeElement?.tagName?.toLowerCase();
  const typing = tag === "input" || tag === "textarea" || document.activeElement?.isContentEditable;
  if (typing) return;

  if (/^[1-9]$/.test(e.key)) {
    const laneNum = parseInt(e.key, 10);
    if (laneNum >= 1 && laneNum <= 12) selectLane(`Lane ${laneNum}`);
  }
});

/* INIT */
(async () => {
  console.log("INIT RUN", new Date().toISOString());

  // show buttons immediately
  buildLaneButtons();
  buildMachineButtons();

  // start on lane mode
  lastSelectedType = "lane";
  els.laneTitle.textContent = selectedLane;
  els.machineTitle.textContent = `Machine: ${selectedMachine}`;
  setRole("forklift");

  els.globalResults.innerHTML = `<div style="color:var(--muted)">Loading...</div>`;

  try{
    await loadLocations();
    inventory = await loadInventory();

    els.itemsPill.textContent = `ITEMS: ${inventory.length}`;
    renderLaneList();
    renderMachineList();
    renderGlobalSearch();
  }catch(err){
    console.error("Init failed:", err);
    els.globalResults.innerHTML = `
      <div style="color:var(--bad); font-weight:900;">API ERROR</div>
      <div style="color:var(--muted); margin-top:6px;">
        Check DevTools → Network for /locations or /items failing.
      </div>
    `;
  }
})();
</script>
