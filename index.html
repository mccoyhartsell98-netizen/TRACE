<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TRACE — Kiosk</title>

  <!-- QR generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b0f16;
      --panel:#101a2a;
      --panel2:#0f1522;
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.7);
      --border:rgba(255,255,255,.12);
      --btn:#0f1b2e;
      --btn2:#122547;
      --accent:#2a7fff;
    }
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Arial;background:radial-gradient(1100px 700px at 25% 10%, rgba(42,127,255,.16), transparent 60%), var(--bg);color:var(--text);}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px;}
    .card{width:min(520px, 95vw);background:linear-gradient(180deg, rgba(16,26,42,.96), rgba(10,14,22,.96));border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden;}
    .top{padding:16px 16px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{font-weight:900;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .body{padding:14px 16px 16px;}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{
      width:100%;background:var(--btn);color:var(--text);
      border:1px solid var(--border);border-radius:14px;
      padding:14px 14px;font-weight:900;letter-spacing:.2px;cursor:pointer;
      transition:.12s transform, .12s background;
    }
    .btn:hover{background:var(--btn2)}
    .btn:active{transform:scale(.985)}
    .btn.secondary{background:transparent}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .pinDots{font-size:22px;letter-spacing:6px;margin:10px 0 6px}
    .msg{font-size:12px;color:var(--muted);min-height:18px}
    input{
      width:100%;background:var(--panel2);color:var(--text);
      border:1px solid var(--border);border-radius:12px;
      padding:12px 12px;font-weight:700;outline:none;
    }
    .section{margin-top:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:rgba(15,21,34,.55)}
    canvas{display:block;margin-top:10px;border-radius:12px;background:#fff}
    .tiny{font-size:12px;color:var(--muted);word-break:break-all;margin-top:8px}
    .hide{display:none!important}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="brand">TRACE</div>
          <div class="sub">Kiosk Access • QR → PIN → Hub</div>
        </div>
        <div class="pill" id="pillStatus">LOCKED</div>
      </div>

      <div class="body">

        <!-- PIN GATE -->
        <div id="viewPin">
          <div style="font-weight:900;">Enter PIN</div>
          <div class="pinDots" id="pinDots">______</div>

          <div class="grid" id="pinPad">
            <button class="btn" data-d="1">1</button>
            <button class="btn" data-d="2">2</button>
            <button class="btn" data-d="3">3</button>
            <button class="btn" data-d="4">4</button>
            <button class="btn" data-d="5">5</button>
            <button class="btn" data-d="6">6</button>
            <button class="btn" data-d="7">7</button>
            <button class="btn" data-d="8">8</button>
            <button class="btn" data-d="9">9</button>
            <button class="btn secondary" id="pinBack">⌫</button>
            <button class="btn" data-d="0">0</button>
            <button class="btn secondary" id="pinClear">C</button>
          </div>

          <div class="grid2">
            <button class="btn" id="pinSubmit">UNLOCK</button>
            <button class="btn secondary" id="pinGoMain">Admin Login</button>
          </div>

          <div class="msg" id="pinMsg"></div>
          <div class="tiny" id="qrPayloadHint"></div>
        </div>

        <!-- HUB -->
        <div id="viewHub" class="hide">
          <div class="row">
            <div style="font-weight:900;" id="hubUser">—</div>
            <button class="btn secondary" style="width:auto;padding:10px 12px" id="hubLogout">Done / Logout</button>
          </div>

          <div class="grid2" style="margin-top:12px">
            <button class="btn" id="hubMove">MOVE</button>
            <button class="btn" id="hubSearch">SEARCH</button>
            <button class="btn" id="hubAdmin">ADMIN</button>
            <button class="btn" id="hubMakeQr">GEN JOB QR</button>
          </div>

          <div class="section hide" id="qrMaker">
            <div style="font-weight:900;">Generate Job QR</div>
            <div class="sub" style="margin-top:4px">Creates a printable PNG for forklift lookup</div>

            <div style="display:grid;gap:8px;margin-top:10px">
              <input id="qrJob" placeholder="Job # (required)" />
              <input id="qrMo" placeholder="MO # (optional)" />
              <input id="qrQty" placeholder="QTY (optional)" />
            </div>

            <div class="grid2" style="margin-top:10px">
              <button class="btn" id="btnGenQR">Generate</button>
              <button class="btn secondary" id="btnDlQR" disabled>Download PNG</button>
            </div>

            <canvas id="jobQrCanvas" width="320" height="320"></canvas>
            <div class="tiny" id="qrUrlText"></div>
          </div>

          <div class="section">
            <div style="font-weight:900;">Quick jump</div>
            <div class="sub" style="margin-top:4px">These buttons send you into the main TRACE app</div>
            <div class="grid2" style="margin-top:10px">
              <button class="btn secondary" id="jumpLane">Lane View</button>
              <button class="btn secondary" id="jumpMachine">Machine View</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ✅ SET THESE
  const MAIN_TRACE_URL = "./index.html";           // your current working UI
  const ADMIN_URL = "./admin.html";
  const API_BASE = "https://trace-api-sak3.onrender.com"; // your Render API base

  // State
  let pinBuf = "";

  // URL payload (from job QR)
  const qs = new URLSearchParams(location.search);
  const payload = {
    job: qs.get("job") || "",
    mo:  qs.get("mo") || "",
    qty: qs.get("qty") || ""
  };

  // UI helpers
  const $ = (id)=>document.getElementById(id);
  const show = (a,b)=>{ $(a).classList.remove("hide"); $(b).classList.add("hide"); };
  const setStatus = (t)=>{ $("pillStatus").textContent = t; };

async function checkApi(){
  try{
    const r = await fetch(`${API_BASE}/health`, { cache: "no-store" });
    if (!r.ok) throw new Error("bad status");
    $("pillStatus").textContent = "LOCKED • API OK";
  }catch(e){
    $("pillStatus").textContent = "LOCKED • API DOWN";
  }
}

  function renderPinDots(){
    $("pinDots").textContent = (pinBuf + "______").slice(0,6).split("").map(ch => ch === "_" ? "_" : "•").join("");
  }

  function hintPayload(){
    const has = payload.job || payload.mo || payload.qty;
    $("qrPayloadHint").textContent = has
      ? `Loaded from QR → Job: ${payload.job || "-"} • MO: ${payload.mo || "-"} • QTY: ${payload.qty || "-"}`
      : "";
  }

  // Auth storage (token + user)
  function saveAuth(token, user){
    localStorage.setItem("trace_pin_token", token);
    localStorage.setItem("trace_pin_user", JSON.stringify(user));
  }
  function getAuth(){
    return {
      token: localStorage.getItem("trace_pin_token"),
      user: JSON.parse(localStorage.getItem("trace_pin_user") || "null")
    };
  }
  function clearAuth(){
    localStorage.removeItem("trace_pin_token");
    localStorage.removeItem("trace_pin_user");
  }

  async function pinLogin(pin){
    const r = await fetch(`${API_BASE}/pin-login`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ pin })
    });
    const data = await r.json().catch(()=> ({}));
    if (!r.ok) throw data;
    return data; // {token, user, last_state}
  }

  function enterHub(user){
    $("hubUser").textContent = `${user.name} (${user.role})`;
    $("hubAdmin").style.display = (user.role === "admin") ? "block" : "none";
    setStatus("UNLOCKED");
    show("viewHub","viewPin");
  }

  function backToPin(msg=""){
    pinBuf = "";
    renderPinDots();
    $("pinMsg").textContent = msg;
    setStatus("LOCKED");
    show("viewPin","viewHub");
  }

  // Jump into main TRACE app (pass token + payload)
  function goToMain(extra = {}){
    const url = new URL(MAIN_TRACE_URL, location.href);
    // Let main app know we came from kiosk
    url.searchParams.set("from","kiosk");
    // pass payload
    if (payload.job) url.searchParams.set("job", payload.job);
    if (payload.mo)  url.searchParams.set("mo", payload.mo);
    if (payload.qty) url.searchParams.set("qty", payload.qty);
    // you can pass an intent, too:
    for (const [k,v] of Object.entries(extra)) url.searchParams.set(k, v);
    location.href = url.toString();
  }

  // QR Generator
  async function genJobQr(){
    const job = $("qrJob").value.trim();
    const mo  = $("qrMo").value.trim();
    const qty = $("qrQty").value.trim();
    if (!job) { alert("Job # required"); return; }

    const url = new URL(location.href);
    url.searchParams.set("job", job);
    if (mo)  url.searchParams.set("mo", mo); else url.searchParams.delete("mo");
    if (qty) url.searchParams.set("qty", qty); else url.searchParams.delete("qty");

    // keep it kiosk
    // (kiosk.html already is kiosk, so no mode param needed here)
    await QRCode.toCanvas($("jobQrCanvas"), url.toString(), { width: 320, margin: 2, errorCorrectionLevel: "M" });
    $("qrUrlText").textContent = url.toString();
    $("btnDlQR").disabled = false;
  }

  function downloadQr(){
    const job = ($("qrJob").value.trim() || "JOB");
    const a = document.createElement("a");
    a.download = `TRACE-${job}-QR.png`;
    a.href = $("jobQrCanvas").toDataURL("image/png");
    a.click();
  }

  // Wire PIN pad
  $("pinPad").addEventListener("click",(e)=>{
    const b = e.target.closest("button");
    if (!b) return;
    const d = b.getAttribute("data-d");
    if (d !== null){
      if (pinBuf.length < 6) pinBuf += d;
      renderPinDots();
    }
  });

  $("pinBack").onclick = ()=>{ pinBuf = pinBuf.slice(0,-1); renderPinDots(); };
  $("pinClear").onclick = ()=>{ pinBuf = ""; renderPinDots(); };

  $("pinSubmit").onclick = async ()=>{
    $("pinMsg").textContent = "Checking...";
    try{
      if (!/^\d{6}$/.test(pinBuf)) { $("pinMsg").textContent = "PIN must be 6 digits"; return; }
      const data = await pinLogin(pinBuf);
      saveAuth(data.token, data.user);
      pinBuf = ""; renderPinDots();
      $("pinMsg").textContent = "";
      enterHub(data.user);
    }catch(err){
      $("pinMsg").textContent = err?.error || "Invalid PIN";
    }
  };

  $("pinGoMain").onclick = ()=>{
  location.href = new URL(ADMIN_URL, location.href).toString();
};

  // Hub buttons
  $("hubLogout").onclick = ()=>{ clearAuth(); backToPin("Logged out."); };
  $("hubMove").onclick = ()=>{ goToMain({ intent:"move" }); };
  $("hubSearch").onclick = ()=>{ goToMain({ intent:"search" }); };
  $("hubAdmin").onclick = ()=>{
  location.href = new URL(ADMIN_URL, location.href).toString();
};
  $("hubMakeQr").onclick = ()=>{ $("qrMaker").classList.toggle("hide"); };

  $("jumpLane").onclick = ()=>{ goToMain({ view:"lane" }); };
  $("jumpMachine").onclick = ()=>{ goToMain({ view:"machine" }); };

  $("btnGenQR").onclick = genJobQr;
  $("btnDlQR").onclick = downloadQr;

  // Boot
hintPayload();
renderPinDots();
checkApi();
backToPin("");
</script>
</body>
</html>
