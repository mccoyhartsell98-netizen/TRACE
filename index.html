<!--
  TRACE INVENTORY
  © 2026 Mccoy Hartsell — All rights reserved.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TRACE</title>

  <!-- PWA / App support -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f1115">

  <!-- iOS install support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TRACE">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#0f1115;
      --panel:rgba(22,26,34,.92);
      --panel2:rgba(27,32,48,.92);
      --text:#ffffff;
      --muted:#b7c0d1;
      --good:#8aff8a;
      --bad:#ff6b6b;
      --warn:#ffd166;
      --stroke:#2b3143;
      --focus:#3a7afe;
    }

    *{box-sizing:border-box}
    html, body{height:100%;margin:0;}

    body{
      overflow:hidden;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--text);
      background:
        linear-gradient(rgba(15,17,21,0.55), rgba(15,17,21,0.55)),
        url("759c4386-0d9e-4dd1-9589-07ef1c92643b.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
    }

    .wrap{
      max-width:1100px;
      height:100vh;
      margin:0 auto;
      padding:18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .top{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }

    .logo{
      grid-column:2;
      justify-self:center;
      width:680px;
      max-width:96vw;
      height:auto;
      display:block;
      filter:
        drop-shadow(0 0 12px rgba(58,122,254,0.35))
        drop-shadow(0 0 28px rgba(58,122,254,0.15));
    }

    .status{
      grid-column:3;
      justify-self:end;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      text-align:right;
      color:var(--muted);
      font-size:14px;
      line-height:1.2;
    }

    .pill{
      padding:6px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }

    .rolebar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex:0 0 auto;
    }

    .roleLeft{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    select, input[type="text"], input[type="number"]{
      width:100%;
      padding:14px 14px;
      font-size:18px;
      border-radius:10px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      outline:none;
    }

    select{
      font-size:16px;
      padding:10px 12px;
      width:auto;
      min-width:170px;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(58,122,254,.18);
    }

    button{
      border:none;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      font-weight:900;
      color:var(--text);
      background:rgba(255,255,255,.08);
      cursor:pointer;
      border:1px solid var(--stroke);
      white-space:nowrap;
    }
    button:hover{background:rgba(255,255,255,.11)}
    .primary{background:rgba(58,122,254,.24); border-color:rgba(58,122,254,.55)}
    .primary:hover{background:rgba(58,122,254,.32)}
    .danger{background:rgba(255,107,107,.16); border-color:rgba(255,107,107,.45)}
    .danger:hover{background:rgba(255,107,107,.22)}
    .ghost{background:transparent}
    .ghost:hover{background:rgba(255,255,255,.06)}

    .grid{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:14px;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:15px;
      letter-spacing:.5px;
      color:var(--muted);
      font-weight:900;
      text-transform:uppercase;
    }

    .scroll{
      overflow:auto;
      padding-right:4px;
      min-height:0;
      flex:1 1 auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) transparent;
    }
    .scroll::-webkit-scrollbar{ width:8px; }
    .scroll::-webkit-scrollbar-track{ background:transparent; }
    .scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .scroll::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.22);
      background-clip: content-box;
    }

    .laneGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
      margin-bottom:10px;
      flex:0 0 auto;
    }

    .laneBtn{
      background:var(--panel2);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:12px 10px;
      text-align:center;
      font-weight:900;
      letter-spacing:.4px;
      cursor:pointer;
      user-select:none;
    }
    .laneBtn:hover{border-color:rgba(58,122,254,.45)}
    .laneBtn.active{
      border-color:rgba(58,122,254,.75);
      box-shadow: 0 0 0 3px rgba(58,122,254,.18);
    }

    .laneHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0 8px 0;
      flex:0 0 auto;
    }

    .laneTitle{font-size:20px;font-weight:900;}
    .laneCount{color:var(--muted);font-size:13px;font-weight:800;}

    .results{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .resultItem{
      background:var(--panel2);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:12px 12px;
      cursor:pointer;
    }
    .resultItem:hover{border-color:rgba(58,122,254,.45)}
    .resultItem.active{
      border-color:rgba(58,122,254,.75);
      box-shadow: 0 0 0 3px rgba(58,122,254,.18);
    }

    .big{font-size:18px;font-weight:900;}
    .meta{color:var(--muted);margin-top:6px;font-size:13px;line-height:1.35;}
    .tiny{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35;}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      flex:0 0 auto;
    }
    .kbd{
      display:inline-block;
      padding:2px 6px;
      border:1px solid var(--stroke);
      border-bottom-width:2px;
      border-radius:6px;
      background:rgba(255,255,255,.03);
      font-weight:900;
      font-size:12px;
      color:var(--muted);
      margin:0 2px;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .formGrid .full{grid-column:1 / -1;}

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99;
      padding:18px;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(900px, 96vw);
      max-height:min(80vh, 720px);
      overflow:auto;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.5);
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{
      font-weight:900;
      font-size:16px;
      letter-spacing:.4px;
      color:var(--muted);
      text-transform:uppercase;
    }

    @media (max-width: 980px){
      body{overflow:auto;}
      .wrap{height:auto;}
      .grid{grid-template-columns:1fr}
      .status{display:none}
      .laneGrid{grid-template-columns: repeat(3,1fr);}
      .logo{width:520px; max-width:92vw;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div></div>
      <!-- DO NOT CHANGE: per your request, this is intentionally png.png -->
      <img src="./trace-logo.png.png" alt="TRACE" class="logo">
      <div class="status">
        <div class="pill" id="rolePill">ROLE: FORKLIFT</div>
        <div class="pill" id="itemsPill">ITEMS: 0</div>
        <div class="pill">F = FULLSCREEN</div>
      </div>
    </div>

    <div class="rolebar">
      <div class="roleLeft">
        <select id="roleSelect">
          <option value="forklift">Forklift</option>
          <option value="machine">Machine</option>
          <option value="admin">Admin (locked)</option>
        </select>
        <button id="adminUnlockBtn" class="primary">Unlock Admin</button>
        <button id="adminLockBtn" class="ghost" style="display:none;">Lock Admin</button>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <button class="ghost" id="historyBtn">History</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Search</h2>

        <div class="scroll">
          <input id="globalSearch" type="text" placeholder="Search Job # (example: 400848)">
          <div class="results" id="globalResults" style="margin-top:10px;"></div>

          <div style="border-top:1px solid var(--stroke); margin:14px 0;"></div>

          <h2 style="margin-top:0;">Lanes</h2>
          <div class="laneGrid" id="laneGrid"></div>

          <div class="laneHeader">
            <div class="laneTitle" id="laneTitle">Lane 1</div>
            <div class="laneCount" id="laneCount">0 items</div>
          </div>

          <input id="laneSearch" type="text" placeholder="Filter within this lane (optional)">
          <div class="results" id="laneResults" style="margin-top:10px;"></div>

          <div style="border-top:1px solid var(--stroke); margin:14px 0;"></div>

          <h2 style="margin-top:0;">Machines</h2>
          <div class="laneGrid" id="machineGrid"></div>

          <div class="laneHeader">
            <div class="laneTitle" id="machineTitle">Machine: S8</div>
            <div class="laneCount" id="machineCount">0 jobs</div>
          </div>

          <input id="machineSearch" type="text" placeholder="Filter within this machine (optional)">
          <div class="results" id="machineResults" style="margin-top:10px;"></div>

          <div class="hint">
            Flow: <b>Search Job #</b> → <b>Move</b> → choose <b>Lane</b> or <b>Machine</b>.
            <br/>
            Keys: <span class="kbd">1–9</span> quick lanes • <span class="kbd">F</span> fullscreen • <span class="kbd">ESC</span> close move box
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>Job Update</h2>

        <div class="scroll">
          <div class="formGrid">
            <div class="full">
              <input id="job" type="text" inputmode="numeric" placeholder="Job # (numbers only, required)">
            </div>

            <div class="full">
              <input id="description" type="text" placeholder="Description (optional)">
            </div>

            <div class="full btnRow">
              <button class="primary" id="saveBtn">Save / Update</button>
              <button id="newBtn">New</button>
              <button class="danger" id="deleteBtn" disabled>Delete</button>
            </div>
          </div>

          <div class="tiny" id="rulesBox">
            <b>Rules:</b>
            <ul>
              <li><b>Job #</b> is the unique key. Once created it is locked.</li>
              <li><b>Forklift</b>: can search + move jobs (no edit, no delete).</li>
              <li><b>Machine</b>: can update description (cannot create new jobs, no delete, no move).</li>
              <li><b>Admin</b>: can create jobs + delete (goes to History) + restore (local restore for now).</li>
            </ul>
          </div>

          <div id="historyPanel" style="display:none; margin-top:12px;">
            <h2>Deleted History (local)</h2>
            <input id="historySearch" type="text" placeholder="Search deleted jobs...">
            <div class="results" id="historyResults" style="margin-top:10px;"></div>
          </div>

          <div style="border-top:1px solid var(--stroke); margin:14px 0;"></div>

          <h2>Backup</h2>
          <div class="btnRow">
            <button id="exportBtn">Export JSON</button>
            <button id="importBtn">Import JSON</button>
          </div>
          <input id="fileInput" type="file" accept="application/json" style="display:none;" />
        </div>
      </div>
    </div>
  </div>

  <!-- MOVE OVERLAY -->
  <div class="overlay" id="moveOverlay">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="moveTitle">Move Job</div>
        <button class="ghost" id="moveCloseBtn">Close</button>
      </div>

      <div style="color:var(--muted); font-weight:900; margin-bottom:8px;">Move to Lane</div>
      <div class="laneGrid" id="moveLaneGrid"></div>

      <div style="border-top:1px solid var(--stroke); margin:14px 0;"></div>

      <div style="color:var(--muted); font-weight:900; margin-bottom:8px;">Move to Machine</div>
      <div class="laneGrid" id="moveMachineGrid"></div>

      <div class="tiny" style="margin-top:12px;">
        Rule: Moving to a <b>Machine</b> clears the lane. Moving to a <b>Lane</b> clears the machine.
      </div>
    </div>
  </div>

<script>
/* =========================
   TRACE — CLEAN (API ALIGNED)
   Schema: items(item_id, job_number, description, location_id, created_at)
   ========================= */

/* API */
const API_BASE = "https://trace-api-sak3.onrender.com";

async function apiGet(path){
  const r = await fetch(`${API_BASE}${path}`);
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}
async function apiPost(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}
async function apiPut(path, body){
  const r = await fetch(`${API_BASE}${path}`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}
async function apiDel(path){
  const r = await fetch(`${API_BASE}${path}`, { method:"DELETE" });
  if(!r.ok) throw new Error(`${path} -> ${r.status}`);
  return r.json();
}

apiGet("/health")
  .then(d => console.log("API CONNECTED", d))
  .catch(e => console.error("API FAILED", e));

/* local deleted history (still local for now) */
const DELETED_KEY = "trace_simple_deleted_v1";

/* MACHINES (required order) */
const MACHINES = ["S8","S9","S61","S62","S63","500","Multi Fold","LCI","Six Lane"];

/* CHANGE THIS PIN ANYTIME */
const ADMIN_PIN = "4793";

/* DOM */
const els = {
  itemsPill: document.getElementById("itemsPill"),
  rolePill: document.getElementById("rolePill"),

  roleSelect: document.getElementById("roleSelect"),
  adminUnlockBtn: document.getElementById("adminUnlockBtn"),
  adminLockBtn: document.getElementById("adminLockBtn"),

  globalSearch: document.getElementById("globalSearch"),
  globalResults: document.getElementById("globalResults"),

  laneGrid: document.getElementById("laneGrid"),
  laneTitle: document.getElementById("laneTitle"),
  laneCount: document.getElementById("laneCount"),
  laneSearch: document.getElementById("laneSearch"),
  laneResults: document.getElementById("laneResults"),

  machineGrid: document.getElementById("machineGrid"),
  machineTitle: document.getElementById("machineTitle"),
  machineCount: document.getElementById("machineCount"),
  machineSearch: document.getElementById("machineSearch"),
  machineResults: document.getElementById("machineResults"),

  moveOverlay: document.getElementById("moveOverlay"),
  moveTitle: document.getElementById("moveTitle"),
  moveCloseBtn: document.getElementById("moveCloseBtn"),
  moveLaneGrid: document.getElementById("moveLaneGrid"),
  moveMachineGrid: document.getElementById("moveMachineGrid"),

  job: document.getElementById("job"),
  description: document.getElementById("description"),
  saveBtn: document.getElementById("saveBtn"),
  newBtn: document.getElementById("newBtn"),
  deleteBtn: document.getElementById("deleteBtn"),

  historyBtn: document.getElementById("historyBtn"),
  historyPanel: document.getElementById("historyPanel"),
  historySearch: document.getElementById("historySearch"),
  historyResults: document.getElementById("historyResults"),

  exportBtn: document.getElementById("exportBtn"),
  importBtn: document.getElementById("importBtn"),
  fileInput: document.getElementById("fileInput"),
};

function normalize(s){ return (s ?? "").toString().trim().toLowerCase(); }
function onlyDigits(s){ return String(s ?? "").replace(/\D+/g, ""); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* STATE */
let locations = [];
let locationById = new Map(); // location_id -> {lane, machine, label}
let inventory = [];           // decorated items for UI

let deletedItems = loadDeleted();

let selectedLane = "Lane 1";
let selectedMachine = MACHINES[0];
let selectedId = null;        // item_id

let role = "forklift";
let adminUnlocked = false;

let moveTargetId = null;

/* deleted history local */
function saveDeleted(){ localStorage.setItem(DELETED_KEY, JSON.stringify(deletedItems)); }
function loadDeleted(){
  try{
    const raw = localStorage.getItem(DELETED_KEY);
    if(!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  }catch{return [];}
}

/* Build location map */
function buildLocationMap(){
  locationById = new Map();
  locations.forEach(loc => {
    const laneNum = (loc.lane === null || loc.lane === undefined) ? null : Number(loc.lane);
    const machine = (loc.machine ?? "").toString().trim();
    const label = machine ? `Machine: ${machine}` : (laneNum ? `Lane ${laneNum}` : "—");
    locationById.set(Number(loc.location_id), { laneNum, machine, label });
  });
}

function getLocationIdForLane(laneStr){
  const laneNum = parseInt(String(laneStr).replace(/\D/g,""), 10);
  const row = locations.find(l => Number(l.lane) === laneNum);
  return row ? Number(row.location_id) : null;
}
function getLocationIdForMachine(machine){
  const row = locations.find(l => String(l.machine ?? "") === String(machine));
  return row ? Number(row.location_id) : null;
}

/* Load + decorate inventory */
async function reloadInventory(){
  const raw = await apiGet("/items");
  const arr = Array.isArray(raw) ? raw : [];

  inventory = arr.map(it => {
    const loc = locationById.get(Number(it.location_id)) || { laneNum:null, machine:"", label:"—" };
    const laneStr = loc.laneNum ? `Lane ${loc.laneNum}` : "";
    const machineStr = loc.machine || "";

    return {
      id: Number(it.item_id),
      job: String(it.job_number ?? ""),
      description: String(it.description ?? ""),
      createdAt: it.created_at ? String(it.created_at) : "",
      location_id: Number(it.location_id),
      lane: laneStr,
      machine: machineStr,
      locationLabel: loc.label
    };
  });

  els.itemsPill.textContent = `ITEMS: ${inventory.length}`;
}

/* ROLE */
function setRole(nextRole){
  role = nextRole;

  if(role !== "admin"){
    adminUnlocked = false;
    els.adminLockBtn.style.display = "none";
    els.adminUnlockBtn.style.display = "inline-block";
  }

  updateRoleUI();
  renderAll();
}

function updateRoleUI(){
  const effectiveRole = (role === "admin" && adminUnlocked) ? "ADMIN" : role.toUpperCase();
  els.rolePill.textContent = `ROLE: ${effectiveRole}`;

  const canDelete = (role === "admin" && adminUnlocked);
  els.deleteBtn.disabled = !canDelete || !selectedId;

  const forklift = role === "forklift";
  const machineRole = role === "machine";
  const admin = (role === "admin" && adminUnlocked);

  // Admin can create (job editable when not selected)
  const canCreate = admin;
  const hasSelection = !!selectedId;

  // Machine role cannot create, only update existing
  if(machineRole && !hasSelection){
    els.saveBtn.disabled = true;
  }else{
    els.saveBtn.disabled = forklift;
  }

  els.newBtn.disabled = forklift;
  els.job.disabled = hasSelection || !canCreate; // once created locked unless admin creating new
  els.description.disabled = forklift;          // forklift cannot edit description
}

/* BUTTONS */
function buildLaneButtons(){
  els.laneGrid.innerHTML = "";
  for(let i=1;i<=12;i++){
    const lane = `Lane ${i}`;
    const btn = document.createElement("div");
    btn.className = "laneBtn" + (lane===selectedLane ? " active" : "");
    btn.textContent = lane;
    btn.addEventListener("click", () => selectLane(lane));
    els.laneGrid.appendChild(btn);
  }
}

function buildMachineButtons(){
  els.machineGrid.innerHTML = "";
  MACHINES.forEach(m => {
    const btn = document.createElement("div");
    btn.className = "laneBtn" + (m===selectedMachine ? " active" : "");
    btn.textContent = m;
    btn.addEventListener("click", () => selectMachine(m));
    els.machineGrid.appendChild(btn);
  });
}

function selectLane(lane){
  selectedLane = lane;
  selectedId = null;
  els.laneTitle.textContent = lane;
  els.laneSearch.value = "";
  buildLaneButtons();
  clearForm(false);
  renderAll();
}
function selectMachine(m){
  selectedMachine = m;
  selectedId = null;
  els.machineTitle.textContent = `Machine: ${m}`;
  els.machineSearch.value = "";
  buildMachineButtons();
  clearForm(false);
  renderAll();
}

/* RENDER */
function renderLaneList(){
  const q = normalize(els.laneSearch.value);
  const laneItemsAll = inventory.filter(x => x.lane === selectedLane);

  let laneItems = laneItemsAll;
  if(q){
    laneItems = laneItemsAll.filter(x =>
      normalize(x.job).includes(q) ||
      normalize(x.description).includes(q)
    );
  }

  els.laneCount.textContent = `${laneItemsAll.length} items`;
  els.laneResults.innerHTML = "";

  if(laneItemsAll.length === 0){
    els.laneResults.innerHTML = `<div style="color:var(--muted)">Empty lane.</div>`;
    return;
  }
  if(laneItems.length === 0){
    els.laneResults.innerHTML = `<div style="color:var(--muted)">No match in this lane.</div>`;
    return;
  }

  laneItems.sort((a,b) => (parseInt(a.job,10)||0) - (parseInt(b.job,10)||0));

  laneItems.forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem" + (item.id===selectedId ? " active" : "");

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="meta">${escapeHtml(item.lane)} • ${escapeHtml(item.description || "—")}</div>
      <div class="tiny">ID: ${item.id} • ${escapeHtml(item.createdAt || "")}</div>
    `;
    div.addEventListener("click", ()=> loadToForm(item.id));
    els.laneResults.appendChild(div);
  });
}

function renderMachineList(){
  const q = normalize(els.machineSearch.value);
  const machineItemsAll = inventory.filter(x => x.machine === selectedMachine);

  let machineItems = machineItemsAll;
  if(q){
    machineItems = machineItemsAll.filter(x =>
      normalize(x.job).includes(q) ||
      normalize(x.description).includes(q)
    );
  }

  els.machineCount.textContent = `${machineItemsAll.length} jobs`;
  els.machineResults.innerHTML = "";

  if(machineItemsAll.length === 0){
    els.machineResults.innerHTML = `<div style="color:var(--muted)">Empty machine.</div>`;
    return;
  }
  if(machineItems.length === 0){
    els.machineResults.innerHTML = `<div style="color:var(--muted)">No match on this machine.</div>`;
    return;
  }

  machineItems.sort((a,b) => (parseInt(a.job,10)||0) - (parseInt(b.job,10)||0));

  machineItems.forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem" + (item.id===selectedId ? " active" : "");

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="meta">Machine: ${escapeHtml(item.machine)} • ${escapeHtml(item.description || "—")}</div>
      <div class="tiny">ID: ${item.id} • ${escapeHtml(item.createdAt || "")}</div>
    `;
    div.addEventListener("click", ()=> loadToForm(item.id));
    els.machineResults.appendChild(div);
  });
}

function renderGlobalSearch(){
  const q = normalize(els.globalSearch.value);
  els.globalResults.innerHTML = "";

  if(!q){
    els.globalResults.innerHTML = `<div style="color:var(--muted)">Type a Job # to search all lanes/machines.</div>`;
    return;
  }

  const matches = inventory
    .filter(x => normalize(x.job).includes(q))
    .slice(0, 20);

  if(matches.length === 0){
    els.globalResults.innerHTML = `<div style="color:var(--muted)">No match found.</div>`;
    return;
  }

  matches.forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem";

    const canMove = (role === "forklift") || (role === "admin" && adminUnlocked);

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="meta">${escapeHtml(item.locationLabel)} • ${escapeHtml(item.description || "—")}</div>
      <div class="tiny">ID: ${item.id}</div>
      ${canMove ? `
        <div class="btnRow" style="margin-top:10px;">
          <button class="primary" data-move="1">Move</button>
        </div>
      ` : ``}
    `;

    const moveBtn = div.querySelector('[data-move]');
    if(moveBtn){
      moveBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openMoveOverlay(item.id);
      });
    }

    div.addEventListener("click", () => {
      if(item.machine) selectMachine(item.machine);
      else if(item.lane) selectLane(item.lane);
      loadToForm(item.id);
    });

    els.globalResults.appendChild(div);
  });
}

function renderAll(){
  renderLaneList();
  renderMachineList();
  renderGlobalSearch();
  if(els.historyPanel && els.historyPanel.style.display !== "none") renderHistory();
}

/* FORM */
function clearForm(clearSelection=true){
  if(clearSelection) selectedId = null;
  els.job.value = "";
  els.description.value = "";
  updateRoleUI();
}

function loadToForm(id){
  const item = inventory.find(x => x.id === id);
  if(!item) return;
  selectedId = id;

  els.job.value = item.job ?? "";
  els.description.value = item.description ?? "";

  updateRoleUI();
  renderAll();
}

/* CREATE/UPDATE */
async function upsertItem(){
  const forklift = role === "forklift";
  const machineRole = role === "machine";
  const admin = (role === "admin" && adminUnlocked);

  if(forklift){
    alert("Forklift role cannot edit job details.");
    return;
  }

  // Machine can only update selected
  if(machineRole && !selectedId){
    alert("Machine role cannot create new jobs. Ask Admin.");
    return;
  }

  const jobRaw = onlyDigits(els.job.value).trim();
  if(!jobRaw){
    alert("Job # is required (numbers only).");
    els.job.focus();
    return;
  }

  const description = (els.description.value || "").trim().slice(0, 200);

  // Pick location from current lane/machine selection:
  // If machine tab is selected, we still allow lane selection to exist.
  // Move operations should be used for changing location — but on create we must set something.
  const currentLaneLoc = getLocationIdForLane(selectedLane);
  const currentMachineLoc = getLocationIdForMachine(selectedMachine);

  // Default create location: lane selection (lane 1..12)
  // If you want default to machine instead, swap priority.
  const location_id = currentLaneLoc || currentMachineLoc;

  if(!location_id){
    alert("No location found. Check /locations seeding.");
    return;
  }

  try{
    if(selectedId){
      // UPDATE: description only (and optionally location if your API accepts it)
      await apiPut(`/items/${selectedId}`, { description });
    }else{
      // CREATE: admin only
      if(!admin){
        alert("Only Admin can create new jobs.");
        return;
      }

      // prevent duplicates in UI (DB should also enforce unique if you add it later)
      const exists = inventory.some(x => normalize(x.job) === normalize(jobRaw));
      if(exists){
        alert("That Job # already exists. Search it and update it instead.");
        return;
      }

      await apiPost(`/items`, { job_number: jobRaw, description, location_id });
    }

    await reloadInventory();
    clearForm(true);
    renderAll();
  }catch(err){
    console.error("SAVE FAILED", err);
    alert("Save failed. Open DevTools → Network and check the /items request.");
  }
}

/* DELETE */
async function deleteSelected(){
  const admin = (role === "admin" && adminUnlocked);
  if(!admin){
    alert("Only Admin can delete.");
    return;
  }
  if(!selectedId) return;

  const item = inventory.find(x => x.id === selectedId);
  const ok = confirm(`Delete Job #${item?.job ?? ""}? (It will go to local History)`);
  if(!ok) return;

  try{
    await apiDel(`/items/${selectedId}`);

    if(item){
      deletedItems.unshift({ ...item, deletedAt: new Date().toISOString() });
      saveDeleted();
    }

    await reloadInventory();
    clearForm(true);
    renderAll();
  }catch(err){
    console.error("DELETE FAILED", err);
    alert("Delete failed. Check Network tab for DELETE /items/:id.");
  }
}

/* MOVE OVERLAY (DB WRITE) */
function openMoveOverlay(id){
  const item = inventory.find(x => x.id === id);
  if(!item) return;

  const allowed = (role === "forklift") || (role === "admin" && adminUnlocked);
  if(!allowed){
    alert("Only Forklift (or Admin) can move jobs.");
    return;
  }

  moveTargetId = id;
  els.moveTitle.textContent = `Move Job #${item.job}`;

  els.moveLaneGrid.innerHTML = "";
  for(let i=1;i<=12;i++){
    const lane = `Lane ${i}`;
    const btn = document.createElement("div");
    btn.className = "laneBtn";
    btn.textContent = lane;
    btn.addEventListener("click", async () => {
      await moveToLane(moveTargetId, lane);
      closeMoveOverlay();
    });
    els.moveLaneGrid.appendChild(btn);
  }

  els.moveMachineGrid.innerHTML = "";
  MACHINES.forEach(m => {
    const btn = document.createElement("div");
    btn.className = "laneBtn";
    btn.textContent = m;
    btn.addEventListener("click", async () => {
      await moveToMachine(moveTargetId, m);
      closeMoveOverlay();
    });
    els.moveMachineGrid.appendChild(btn);
  });

  els.moveOverlay.classList.add("show");
}

function closeMoveOverlay(){
  els.moveOverlay.classList.remove("show");
  moveTargetId = null;
}

async function moveToLane(id, lane){
  const locId = getLocationIdForLane(lane);
  if(!locId){
    alert("Lane location not found in /locations.");
    return;
  }
  try{
    await apiPut(`/items/${id}`, { location_id: locId });
    await reloadInventory();
    selectLane(lane);
    loadToForm(id);
  }catch(err){
    console.error("MOVE TO LANE FAILED", err);
    alert("Move failed. Check PUT /items/:id payload.");
  }
}

async function moveToMachine(id, machine){
  const locId = getLocationIdForMachine(machine);
  if(!locId){
    alert("Machine location not found in /locations.");
    return;
  }
  try{
    await apiPut(`/items/${id}`, { location_id: locId });
    await reloadInventory();
    selectMachine(machine);
    loadToForm(id);
  }catch(err){
    console.error("MOVE TO MACHINE FAILED", err);
    alert("Move failed. Check PUT /items/:id payload.");
  }
}

/* HISTORY (local only) */
function toggleHistory(){
  const open = els.historyPanel.style.display !== "none";
  els.historyPanel.style.display = open ? "none" : "block";
  if(!open){
    els.historySearch.value = "";
    renderHistory();
  }
}

function renderHistory(){
  const q = normalize(els.historySearch.value);
  els.historyResults.innerHTML = "";

  let list = deletedItems;
  if(q){
    list = deletedItems.filter(x =>
      normalize(x.job).includes(q) ||
      normalize(x.lane).includes(q) ||
      normalize(x.machine).includes(q)
    );
  }

  if(list.length === 0){
    els.historyResults.innerHTML = `<div style="color:var(--muted)">No deleted jobs.</div>`;
    return;
  }

  list.slice(0, 80).forEach(item => {
    const div = document.createElement("div");
    div.className = "resultItem";

    div.innerHTML = `
      <div class="big">Job #${escapeHtml(item.job)}</div>
      <div class="meta">${escapeHtml(item.locationLabel || (item.lane || item.machine || "—"))} • ${escapeHtml(item.description || "—")}</div>
      <div class="tiny">Deleted: ${escapeHtml(item.deletedAt || "—")}</div>
    `;
    els.historyResults.appendChild(div);
  });
}

/* BACKUP */
function exportJson(){
  const blob = new Blob([JSON.stringify(inventory, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `trace_backup_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

function importJsonFile(file){
  // This import is UI-only: it does NOT push to DB.
  // Use it for offline review/testing.
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(!Array.isArray(data)) throw new Error("Invalid file format.");
      inventory = data.map(x => ({
        id: Number(x.id || x.item_id || 0),
        job: String(x.job || x.job_number || ""),
        description: String(x.description || ""),
        createdAt: String(x.createdAt || x.created_at || ""),
        location_id: Number(x.location_id || 0),
        lane: String(x.lane || ""),
        machine: String(x.machine || ""),
        locationLabel: String(x.locationLabel || "")
      })).filter(x => x.job);

      els.itemsPill.textContent = `ITEMS: ${inventory.length}`;
      clearForm(true);
      renderAll();
      alert("Import loaded into UI (not saved to DB).");
    }catch(e){
      alert("Import failed: " + e.message);
    }
  };
  reader.readAsText(file);
}

/* FULLSCREEN */
function toggleFullscreen(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  }else{
    document.exitFullscreen().catch(()=>{});
  }
}

/* EVENTS */
els.globalSearch.addEventListener("input", renderGlobalSearch);
els.laneSearch.addEventListener("input", renderLaneList);
els.machineSearch.addEventListener("input", renderMachineList);

els.saveBtn.addEventListener("click", upsertItem);
els.newBtn.addEventListener("click", () => clearForm(true));
els.deleteBtn.addEventListener("click", deleteSelected);

els.exportBtn.addEventListener("click", exportJson);
els.importBtn.addEventListener("click", () => els.fileInput.click());
els.fileInput.addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  if(file) importJsonFile(file);
  els.fileInput.value = "";
});

els.historyBtn.addEventListener("click", toggleHistory);
els.historySearch.addEventListener("input", renderHistory);

els.moveCloseBtn.addEventListener("click", closeMoveOverlay);
els.moveOverlay.addEventListener("click", (e) => {
  if(e.target === els.moveOverlay) closeMoveOverlay();
});

/* Role events */
els.roleSelect.addEventListener("change", (e) => {
  const v = e.target.value;
  if(v === "admin") setRole("admin");
  else setRole(v);
});

els.adminUnlockBtn.addEventListener("click", () => {
  const pin = prompt("Enter Admin PIN:");
  if(pin === null) return;
  if(String(pin).trim() !== ADMIN_PIN){
    alert("Wrong PIN.");
    els.roleSelect.value = "forklift";
    setRole("forklift");
    return;
  }
  role = "admin";
  adminUnlocked = true;
  els.adminUnlockBtn.style.display = "none";
  els.adminLockBtn.style.display = "inline-block";
  els.roleSelect.value = "admin";
  updateRoleUI();
  renderAll();
});

els.adminLockBtn.addEventListener("click", () => {
  adminUnlocked = false;
  els.adminLockBtn.style.display = "none";
  els.adminUnlockBtn.style.display = "inline-block";
  els.roleSelect.value = "forklift";
  setRole("forklift");
});

els.job.addEventListener("input", () => {
  els.job.value = onlyDigits(els.job.value);
});

document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "f") toggleFullscreen();
  if(e.key === "Escape") closeMoveOverlay();

  const tag = document.activeElement?.tagName?.toLowerCase();
  const typing = tag === "input" || tag === "textarea" || document.activeElement?.isContentEditable;
  if (typing) return;

  if (/^[1-9]$/.test(e.key)) {
    const laneNum = parseInt(e.key, 10);
    if (laneNum >= 1 && laneNum <= 12) selectLane(`Lane ${laneNum}`);
  }
});

[els.job, els.description].forEach(el => {
  el.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      if(!els.saveBtn.disabled) upsertItem();
    }
  });
});

/* INIT (ONLY ONCE) */
(async () => {
  console.log("INIT RUN", new Date().toISOString());

  try{
    locations = await apiGet("/locations");
    buildLocationMap();

    await reloadInventory();

    buildLaneButtons();
    buildMachineButtons();

    els.laneTitle.textContent = selectedLane;
    els.machineTitle.textContent = `Machine: ${selectedMachine}`;

    setRole("forklift");
    renderAll();
  }catch(err){
    console.error("Init failed:", err);
    alert("Init failed. Check console + Network. Most likely /locations or /items error.");
  }
})();
</script>
</body>
</html>
